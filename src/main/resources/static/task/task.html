<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä»»åŠ¡åˆ—è¡¨ - å®æ—¶è¿›åº¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
        }

        .nav-links {
            margin-bottom: 20px;
        }

        .nav-links a {
            margin-right: 15px;
            padding: 10px 15px;
            text-decoration: none;
            background-color: #e0e0e0;
            border-radius: 4px;
        }

        .nav-links a:hover {
            background-color: #d0d0d0;
        }

        .task-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #e0e0e0;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #d0d0d0;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-info {
            background-color: #2196F3;
            color: white;
        }

        .btn-info:hover {
            background-color: #1976D2;
        }

        .form-group {
            margin: 10px 0;
        }

        .form-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }

        .form-group input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .task-item {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4CAF50;
        }

        .progress-bar {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            height: 20px;
        }

        /* è¿›åº¦æ¡å¡«å……é¢œè‰² */
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
            transition: width 0.3s ease;
        }

        .progress-fill.status-running {
            background-color: #4CAF50;
        }

        .progress-fill.status-completed {
            background-color: #4CAF50;
        }

        .progress-fill.status-failed {
            background-color: #f44336;
        }

        .task-info {
            margin: 10px 0;
        }

        /* ä»»åŠ¡çŠ¶æ€æ ·å¼ */
        .task-status {
            color: #2196F3;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }

        .task-status.status-running {
            background-color: #e3f2fd;
            color: #2196F3;
        }

        .task-status.status-completed {
            background-color: #e8f5e9;
            color: #4CAF50;
        }

        .task-status.status-failed {
            background-color: #ffebee;
            color: #f44336;
        }

        .sub-tasks {
            margin-top: 15px;
        }

        .sub-task {
            padding: 8px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-left: 3px solid #6c757d;
            border-radius: 4px;
        }

        .sub-task-name {
            font-weight: bold;
        }

        .sub-task-duration {
            color: #6c757d;
            font-size: 12px;
        }

        .task-time {
            color: #6c757d;
            font-size: 12px;
        }

        .task-history {
            margin-top: 30px;
        }

        .task-history-item {
            padding: 15px;
            margin: 8px 0;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }

        .task-history-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .task-history-item strong {
            color: #333;
            font-size: 14px;
        }

        .task-id {
            font-size: 12px;
            opacity: 0.7;
        }

        .data-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .data-info-item {
            margin: 5px 0;
        }

        .result-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }

        .result-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š ä¸»ä»»åŠ¡åˆ—è¡¨ - å®æ—¶è¿›åº¦</h1>

    <div class="nav-links">
        <a href="subtask.html">ğŸ”§ å­ä»»åŠ¡ç²¾ç»†åŒ–æ“ä½œ â†’</a>
    </div>

    <!-- ä¸»è¦ä»»åŠ¡åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">ğŸš€ ä¸»è¦ä»»åŠ¡</h2>
        <button class="btn-primary" onclick="startTask('/api/task/refreshAll__lataDay', 'å¢é‡æ›´æ–° (ç›˜ä¸­)')">
            ğŸ”„ å¢é‡æ›´æ–° (ç›˜ä¸­)
        </button>
        <button class="btn-primary" onclick="startTask('/api/task/refreshAll', 'å…¨é‡æ›´æ–° (ç›˜å)')">
            ğŸ”„ å…¨é‡æ›´æ–° (ç›˜å)
        </button>
        <button onclick="loadActiveTasks()">ğŸ”„ åˆ·æ–°æ´»è·ƒä»»åŠ¡</button>
    </div>

    <!-- æ•°æ®ä¿¡æ¯åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">ğŸ“ˆ æ•°æ®ä¿¡æ¯</h2>
        <button class="btn-info" onclick="loadDataInfo()">ğŸ“Š è·å–æœ€æ–°æ•°æ®ä¿¡æ¯</button>
        <div id="data-info-container"></div>
    </div>

    <!-- ä¸œæ–¹è´¢å¯Œè®¾ç½®åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">ğŸ’° ä¸œæ–¹è´¢å¯Œè®¾ç½®</h2>
        <div class="form-group">
            <label for="validatekey">ValidateKey:</label>
            <input type="text" id="validatekey" placeholder="è¯·è¾“å…¥validatekey" style="width: 300px;">
        </div>
        <div class="form-group">
            <label for="cookie">Cookie:</label>
            <input type="text" id="cookie" placeholder="è¯·è¾“å…¥cookie" style="width: 300px;">
        </div>
        <button class="btn-warning" onclick="refreshEastmoneySession()">ğŸ”„ åˆ·æ–°ä¸œæ–¹è´¢å¯Œä¼šè¯</button>
        <div id="eastmoney-result"></div>
    </div>

    <!-- ç¼“å­˜åˆ·æ–°åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">ğŸ’¾ ç¼“å­˜ç®¡ç†</h2>
        <div class="form-group">
            <label for="cacheRefresh">refresh:</label>
            <select id="cacheRefresh" style="width: 200px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="true" selected>true</option>
                <option value="false">false</option>
            </select>
        </div>
        <button class="btn-info" onclick="refreshInitDataCache()">ğŸ”„ åˆ·æ–°å›æµ‹ç¼“å­˜</button>
        <div id="cache-result"></div>
    </div>

    <!-- æ´»è·ƒä»»åŠ¡åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">âš¡ æ´»è·ƒä»»åŠ¡</h2>
        <div id="active-tasks" class="task-list"></div>
    </div>

    <!-- ä»»åŠ¡å†å²åŒºåŸŸ -->
    <div class="task-section">
        <h2 class="section-title">ğŸ“œ ä»»åŠ¡å†å²</h2>
        <div id="task-history" class="task-history"></div>
    </div>
</div>

<script>
    let ws = null;
    let subscribedTasks = new Set();

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function () {
        connectWebSocket();
        loadActiveTasks();
        loadTaskHistory();

        // ä»LocalStorageæ¢å¤è®¢é˜…
        const savedSubscriptions = localStorage.getItem('taskSubscriptions');
        if (savedSubscriptions) {
            const subscriptions = JSON.parse(savedSubscriptions);
            subscriptions.forEach(taskId => {
                subscribeToTask(taskId);
            });
        }
    };

    // é¡µé¢å…³é—­å‰ä¿å­˜è®¢é˜…çŠ¶æ€
    window.onbeforeunload = function () {
        localStorage.setItem('taskSubscriptions', JSON.stringify(Array.from(subscribedTasks)));
    };

    function connectWebSocket() {
        if (ws) {
            ws.close();
        }

        ws = new WebSocket('ws://' + window.location.host + '/ws/task-progress');

        ws.onopen = function () {
            console.log('WebSocketè¿æ¥å·²å»ºç«‹');
            // é‡æ–°è®¢é˜…æ‰€æœ‰ä»»åŠ¡
            subscribedTasks.forEach(taskId => {
                ws.send('SUBSCRIBE:' + taskId);
            });
        };

        ws.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (Array.isArray(data)) {
                    updateActiveTasksUI(data);
                } else if (data.taskId) {
                    updateTaskUI(data);
                }
            } catch (e) {
                console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', event.data);
            }
        };

        ws.onerror = function (error) {
            console.error('WebSocketé”™è¯¯:', error);
        };

        ws.onclose = function () {
            console.log('WebSocketè¿æ¥å·²å…³é—­ï¼Œ5ç§’åé‡è¿');
            setTimeout(connectWebSocket, 5000);
        };
    }

    function startTask(apiPath, taskName) {
        fetch(apiPath, {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    if (data.data && typeof data.data === 'string') {
                        // æ˜¯ä»»åŠ¡ID
                        const taskId = data.data;
                        addTaskToUI(taskId, taskName);
                        subscribeToTask(taskId);
                        saveTaskToLocalStorage(taskId, taskName);
                    } else {
                        // ä¸æ˜¯ä»»åŠ¡ï¼Œæ˜¾ç¤ºç»“æœ
                        showResultMessage('æ“ä½œæˆåŠŸ', 'success');
                    }
                } else {
                    showResultMessage('æ“ä½œå¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            })
            .catch(err => {
                showResultMessage('è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
            });
    }

    function subscribeToTask(taskId) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send('SUBSCRIBE:' + taskId);
            subscribedTasks.add(taskId);
        }
    }

    function loadActiveTasks() {
        fetch('/api/task/activeTasks', {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    updateActiveTasksUI(data.data);
                    // è‡ªåŠ¨è®¢é˜…æ‰€æœ‰æ´»è·ƒä»»åŠ¡
                    data.data.forEach(task => {
                        if (task.taskId) {
                            subscribeToTask(task.taskId);
                        }
                    });
                }
            })
            .catch(err => {
                console.error('åŠ è½½æ´»è·ƒä»»åŠ¡å¤±è´¥:', err);
            });
    }

    function loadTaskHistory() {
        fetch('/api/task/taskHistory', {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    updateTaskHistoryUI(data.data);
                }
            })
            .catch(err => {
                console.error('åŠ è½½ä»»åŠ¡å†å²å¤±è´¥:', err);
            });
    }

    function loadDataInfo() {
        fetch('/api/task/dataInfo', {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    displayDataInfo(data.data);
                } else {
                    showResultMessage('è·å–æ•°æ®ä¿¡æ¯å¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            })
            .catch(err => {
                showResultMessage('è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
            });
    }

    function refreshEastmoneySession() {
        const validatekey = document.getElementById('validatekey').value;
        const cookie = document.getElementById('cookie').value;

        if (!validatekey || !cookie) {
            showResultMessage('è¯·å¡«å†™å®Œæ•´çš„å‚æ•°', 'error', 'eastmoney-result');
            return;
        }

        const params = new URLSearchParams({validatekey: validatekey, cookie: cookie});
        fetch('/api/task/eastmoney/refreshSession?' + params.toString(), {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showResultMessage('ä¸œæ–¹è´¢å¯Œä¼šè¯åˆ·æ–°æˆåŠŸ', 'success', 'eastmoney-result');
                } else {
                    showResultMessage('ä¼šè¯åˆ·æ–°å¤±è´¥: ' + JSON.stringify(data), 'error', 'eastmoney-result');
                }
            })
            .catch(err => {
                showResultMessage('è¯·æ±‚å¤±è´¥: ' + err.message, 'error', 'eastmoney-result');
            });
    }

    function refreshInitDataCache() {
        const refresh = document.getElementById('cacheRefresh').value;
        const refreshType = refresh === 'true' ? 'å¼ºåˆ¶' : 'å¢é‡';

        fetch(`/api/task/initData/refresh?refresh=${refresh}`, {method: 'GET'})
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showResultMessage(`å›æµ‹ç¼“å­˜åˆ·æ–°(${refreshType})æˆåŠŸ`, 'success', 'cache-result');
                } else {
                    showResultMessage('ç¼“å­˜åˆ·æ–°å¤±è´¥: ' + JSON.stringify(data), 'error', 'cache-result');
                }
            })
            .catch(err => {
                showResultMessage('è¯·æ±‚å¤±è´¥: ' + err.message, 'error', 'cache-result');
            });
    }

    function addTaskToUI(taskId, taskName) {
        const tasksDiv = document.getElementById('active-tasks');
        const existingTask = document.getElementById('task-' + taskId);
        if (existingTask) return;

        const taskDiv = document.createElement('div');
        taskDiv.id = 'task-' + taskId;
        taskDiv.className = 'task-item';
        taskDiv.innerHTML = `
            <h3>${taskName} (${taskId.substring(0, 20)}...)</h3>
            <div class="progress-bar">
                <div class="progress-fill status-running" style="width: 0%">0%</div>
            </div>
            <div class="task-info">
                <div>çŠ¶æ€: <span class="task-status">å‡†å¤‡ä¸­...</span></div>
                <div>å½“å‰æ­¥éª¤: <span class="current-step">å‡†å¤‡ä¸­...</span></div>
                <div class="task-time">è€—æ—¶: <span class="running-time">-</span></div>
                <div class="task-time">å¼€å§‹æ—¶é—´: <span class="start-time">-</span></div>
                <div>ID: <span class="task-id">${taskId}</span></div>
            </div>
            <div class="sub-tasks"></div>
        `;
        tasksDiv.appendChild(taskDiv);
    }

    function updateActiveTasksUI(tasks) {
        const tasksDiv = document.getElementById('active-tasks');
        tasksDiv.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            tasksDiv.innerHTML = '<p>æš‚æ— æ´»è·ƒä»»åŠ¡</p>';
            return;
        }

        tasks.forEach(task => {
            if (task.taskId) {
                addTaskToUI(task.taskId, task.taskName);
                updateTaskUI(task);
            }
        });
    }

    function updateTaskHistoryUI(tasks) {
        const historyDiv = document.getElementById('task-history');
        historyDiv.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            historyDiv.innerHTML = '<p>æš‚æ— ä»»åŠ¡å†å²</p>';
            return;
        }

        tasks.slice(0, 10).forEach(task => {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-history-item';
            const durationText = formatDuration(task.totalTime);

            // ç¡®ä¿çŠ¶æ€ç±»åæ­£ç¡®åº”ç”¨
            const statusClass = 'status-' + task.status.toLowerCase();

            taskDiv.innerHTML = `
                <div><strong>${task.taskName}</strong></div>
                <div>çŠ¶æ€: <span class="task-status ${statusClass}">${task.status}</span></div>
                <div class="task-time">è€—æ—¶: ${durationText}</div>
                <div class="task-time">å¼€å§‹æ—¶é—´: ${task.startTime}</div>
                <div class="task-id">ID: ${task.taskId.substring(0, 30)}...</div>
            `;
            historyDiv.appendChild(taskDiv);
        });
    }

    function displayDataInfo(data) {
        const container = document.getElementById('data-info-container');
        if (!data) {
            container.innerHTML = '<p>æš‚æ— æ•°æ®ä¿¡æ¯</p>';
            return;
        }

        let html = '<div class="data-info">';

        // ä¸ªè‚¡æ•°æ®
        if (data.stock_tradeDate) {
            html += `
                <div class="data-info-item"><strong>ä¸ªè‚¡æ•°æ®:</strong></div>
                <div class="data-info-item">äº¤æ˜“æ—¥æœŸ: ${data.stock_tradeDate}</div>
                <div class="data-info-item">æ›´æ–°æ—¶é—´: ${data.stock_updateTime || 'N/A'}</div>
            `;
        }

        // æ¿å—æ•°æ®
        if (data.block_tradeDate) {
            html += `
                <div class="data-info-item"><strong>æ¿å—æ•°æ®:</strong></div>
                <div class="data-info-item">äº¤æ˜“æ—¥æœŸ: ${data.block_tradeDate}</div>
                <div class="data-info-item">æ›´æ–°æ—¶é—´: ${data.block_updateTime || 'N/A'}</div>
            `;
        }

        // ä¸»çº¿æ¿å—æ•°æ®
        if (data.topBlock_tradeDate) {
            html += `
                <div class="data-info-item"><strong>ä¸»çº¿æ¿å—æ•°æ®:</strong></div>
                <div class="data-info-item">äº¤æ˜“æ—¥æœŸ: ${data.topBlock_tradeDate}</div>
                <div class="data-info-item">æ›´æ–°æ—¶é—´: ${data.topBlock_updateTime || 'N/A'}</div>
            `;
        }

        // å¤§ç›˜é‡åŒ–æ•°æ®
        if (data.market_tradeDate) {
            html += `
                <div class="data-info-item"><strong>å¤§ç›˜é‡åŒ–æ•°æ®:</strong></div>
                <div class="data-info-item">äº¤æ˜“æ—¥æœŸ: ${data.market_tradeDate}</div>
                <div class="data-info-item">æ›´æ–°æ—¶é—´: ${data.market_updateTime || 'N/A'}</div>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function updateTaskUI(progress) {
        const taskDiv = document.getElementById('task-' + progress.taskId);
        if (!taskDiv) return;

        const progressBar = taskDiv.querySelector('.progress-fill');
        const taskStatus = taskDiv.querySelector('.task-status');
        const currentStep = taskDiv.querySelector('.current-step');
        const runningTimeSpan = taskDiv.querySelector('.running-time');
        const startTimeSpan = taskDiv.querySelector('.start-time');
        const subTasksDiv = taskDiv.querySelector('.sub-tasks');

        // æ›´æ–°è¿›åº¦æ¡
        if (progressBar) {
            progressBar.style.width = progress.progress + '%';
            progressBar.textContent = progress.progress + '%';
            // æ ¹æ®çŠ¶æ€è®¾ç½®è¿›åº¦æ¡é¢œè‰²
            progressBar.className = 'progress-fill';
            if (progress.status === 'RUNNING') {
                progressBar.classList.add('status-running');
            } else if (progress.status === 'COMPLETED') {
                progressBar.classList.add('status-completed');
            } else if (progress.status === 'FAILED') {
                progressBar.classList.add('status-failed');
            }
        }

        // æ›´æ–°çŠ¶æ€
        if (taskStatus) {
            taskStatus.textContent = progress.status;
            taskStatus.className = 'task-status';
            if (progress.status === 'RUNNING') {
                taskStatus.classList.add('status-running');
            } else if (progress.status === 'COMPLETED') {
                taskStatus.classList.add('status-completed');
            } else if (progress.status === 'FAILED') {
                taskStatus.classList.add('status-failed');
            }
        }

        if (currentStep) {
            currentStep.textContent = progress.currentSubTask || 'å‡†å¤‡ä¸­...';
        }

        if (runningTimeSpan) {
            let timeText = '-';
            if (progress.status === 'RUNNING' && progress.runningTime) {
                timeText = formatDuration(progress.runningTime);
            } else if (progress.totalTime && progress.totalTime !== '0') {
                timeText = formatDuration(progress.totalTime);
            }
            runningTimeSpan.textContent = timeText;
        }

        if (startTimeSpan) {
            if (progress.startTime) {
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                startTimeSpan.textContent = progress.startTime;
            } else {
                startTimeSpan.textContent = '-';
            }
        }

        // æ˜¾ç¤ºå­ä»»åŠ¡è€—æ—¶
        if (subTasksDiv && Array.isArray(progress.subTasks)) {
            if (progress.subTasks.length === 0) {
                subTasksDiv.innerHTML = '<p style="color: #999; font-style: italic; text-align: center;">æš‚æ— å­ä»»åŠ¡</p>';
            } else {
                subTasksDiv.innerHTML = progress.subTasks.map(sub => {
                    let durationText = 'æ‰§è¡Œä¸­...';
                    if (sub.duration && sub.duration !== '0') {
                        durationText = formatDuration(sub.duration);
                    } else if (sub.runningTime) {
                        durationText = formatDuration(sub.runningTime);
                    }

                    // æ·»åŠ å­ä»»åŠ¡å¼€å§‹æ—¶é—´
                    let subStartTime = '-';
                    if (sub.startTime) {
                        subStartTime = sub.startTime;
                    }

                    // å­ä»»åŠ¡çŠ¶æ€ï¼ˆç¡®ä¿çŠ¶æ€ç±»åæ­£ç¡®åº”ç”¨ï¼‰
                    const statusClass = 'status-' + sub.status.toLowerCase();

                    return `<div class="sub-task">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div class="sub-task-name">${sub.name}</div>
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    çŠ¶æ€: <span class="task-status ${statusClass}">${sub.status}</span>
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    è€—æ—¶: ${durationText}
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                    å¼€å§‹æ—¶é—´: ${subStartTime}
                                </div>
                            </div>`;
                }).join('');
            }
        }
    }

    function saveTaskToLocalStorage(taskId, taskName) {
        const tasks = JSON.parse(localStorage.getItem('recentTasks') || '[]');
        const taskExists = tasks.some(t => t.id === taskId);
        if (!taskExists) {
            tasks.push({id: taskId, name: taskName, timestamp: Date.now()});
            if (tasks.length > 20) {
                tasks.shift();
            }
            localStorage.setItem('recentTasks', JSON.stringify(tasks));
        }
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatDuration(milliseconds) {
        if (!milliseconds || milliseconds === '0') return '-';

        const ms = parseInt(milliseconds);

        // å°äº1ç§’æ˜¾ç¤º æ¯«ç§’
        if (ms < 1000) {
            return `${ms}ms`;
        }

        // å°äº1åˆ†é’Ÿæ˜¾ç¤º ç§’
        const seconds = ms / 1000;
        if (seconds < 60) {
            return `${seconds.toFixed(1)}ç§’`;
        }

        // å°äº1å°æ—¶æ˜¾ç¤º åˆ†é’Ÿå’Œç§’
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        if (minutes < 60) {
            if (remainingSeconds === 0) {
                return `${minutes}åˆ†`;
            }
            return `${minutes}åˆ†${remainingSeconds}ç§’`;
        }

        // å¤§äºç­‰äº1å°æ—¶æ˜¾ç¤º å°æ—¶ã€åˆ†é’Ÿå’Œç§’
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = Math.floor(minutes % 60);
        if (remainingSeconds === 0 && remainingMinutes === 0) {
            return `${hours}æ—¶`;
        } else if (remainingSeconds === 0) {
            return `${hours}æ—¶${remainingMinutes}åˆ†`;
        }
        return `${hours}æ—¶${remainingMinutes}åˆ†${remainingSeconds}ç§’`;
    }

    // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
    function showResultMessage(message, type, containerId = null) {
        const container = containerId ? document.getElementById(containerId) : document.body;
        const resultDiv = document.createElement('div');
        resultDiv.className = `result-message result-${type}`;
        resultDiv.textContent = message;

        if (containerId) {
            container.innerHTML = '';
            container.appendChild(resultDiv);
        } else {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šå®¹å™¨ï¼Œåœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤º
            const firstChild = container.firstChild;
            container.insertBefore(resultDiv, firstChild);
        }

        // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
        setTimeout(() => {
            if (resultDiv.parentNode) {
                resultDiv.parentNode.removeChild(resultDiv);
            }
        }, 3000);
    }
</script>

</body>
</html>