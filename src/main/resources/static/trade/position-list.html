<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的持仓</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 添加全局配置文件 -->
    <script src="../js/config.js"></script>
    <style>
        .sort-icon {
            margin-left: 4px;
            font-size: 12px;
        }

        .margin-buy-button, .buy-button, .sell-button {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            text-decoration: none; /* Remove underline from links */
            display: inline-block; /* Make links behave like buttons */
            margin: 0 2px; /* Add some space between buttons */
        }

        .margin-buy-button {
            font-size: 12px;
            padding: 5px;
            background-color: #ed6a6a; /* Red for Margin Buy */
        }

        .buy-button {
            font-size: 12px;
            padding: 5px;
            background-color: #c68989; /* Brownish for Buy */
        }

        .sell-button {
            font-size: 12px;
            padding: 5px;
            background-color: #73b5ea; /* Blue for Sell */
        }


        /* --- 持仓列表：批量卖出 --- */
        /* 全选 */
        #positionSelectAllCheckboxHeader {
            transform: scale(1.0);
            margin-right: 5px;
        }

        /* 单个 勾选☑️ */
        .sell-checkbox {
            transform: scale(1.2); /* 复选框大小：1.0 是默认，1.2 ≈ 放大 20% */
            margin: 0 auto; /* 居中 */
            display: block;
        }

        /* Style for the Sell All button */
        #sellPositionsButton {
            margin-left: 10px; /* Add some space */
        }

        /* --- 新增：一键再融资按钮样式 --- */
        #quickResetFinancingButton {
            margin-left: 10px; /* Add some space */
        }

        /* --- 新增：一键取款按钮样式 --- */
        #quickLowerFinancingButton {
            margin-left: 5px; /* Space between input and button */
        }

        /* --- 样式调整：缩小表格字体 --- */
        #positionTable, #ordersTable, #topBlocksTable, #topStocksTable, #topBlocksTableManual, #topStocksTableManual {
            font-size: 13px;
        }

        #positionTable th, #positionTable td,
        #ordersTable th, #ordersTable td,
        #topBlocksTable th, #topBlocksTable td,
        #topStocksTable th, #topStocksTable td,
        #topBlocksTableManual th, #topBlocksTableManual td,
        #topStocksTableManual th, #topStocksTableManual td {
            padding: 4px 6px;
            vertical-align: middle;
            text-align: center;
        }

        /* 我的持仓 列样式 */
        #positionTable th:nth-child(1), /* checkbook */
        #positionTable td:nth-child(1),
        #positionTable th:nth-child(2), /* 序号 */
        #positionTable td:nth-child(2),
        #positionTable th:nth-child(21), /* 操作 */
        #positionTable td:nth-child(21),
        #positionTable th:nth-child(20), /* 主线板块 列 */
        #positionTable td:nth-child(20) {
            text-align: center; /* 居中 */
        }

        #positionTable th:nth-child(2), /* 证券代码 */
        #positionTable td:nth-child(2),
        #positionTable th:nth-child(3), /* 证券名称 */
        #positionTable td:nth-child(3) {
            text-align: left;
        }

        /* 我的持仓 列样式 */
        #positionTable th:nth-child(n+4):nth-child(-n+17):not(:nth-child(4)):not(:nth-child(18)), /* 除了市场列和新增列，其他数字列 */
        #positionTable td:nth-child(n+4):nth-child(-n+17):not(:nth-child(4)):not(:nth-child(18)) {
            text-align: center;
        }


        /* 当日委托 列样式 */
        #ordersTable th:nth-child(3), /* 证券代码 */
        #ordersTable td:nth-child(3),
        #ordersTable th:nth-child(4), /* 证券名称 */
        #ordersTable td:nth-child(4) {
            text-align: left; /* Align left for Code and Name */
        }

        #ordersTable th:nth-child(n+6):nth-child(-n+11), /* 数量, 价格, 金额列 */
        #ordersTable td:nth-child(n+6):nth-child(-n+11) {
            text-align: center;
        }

        /* --- 当日委托新增样式 --- */
        /* 撤单按钮 */
        .cancel-order-button {
            color: white;
            background-color: #6c757d; /* Bootstrap secondary color */
            border: none;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .cancel-order-button:hover {
            background-color: #5a6268;
        }

        .cancel-order-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        .order-status-已撤 {
            color: gray;
            font-style: italic;
        }

        .order-status-废单 {
            color: red;
            font-weight: bold;
        }

        .order-status-已成 {
            color: green;
        }

        .order-status-部成 {
            color: orange; /* Or blue */
        }

        /* --- 当日委托：批量撤单 --- */
        /* 全选 */
        #ordersSelectAllCheckboxHeader {
            transform: scale(1.0);
            margin-right: 5px;
        }

        /* 单个 勾选☑️ */
        .order-checkbox {
            transform: scale(1.2);
            margin: 0 auto;
            display: block;
        }

        /* Style for the Batch Cancel button */
        #batchCancelOrdersButton {
            margin-left: 10px; /* Add some space */
        }

        /* Style for the Quick Cancel button */
        #quickCancelOrdersButton {
            margin-left: 10px; /* Add some space */
        }

        /* ----------------------------- */
        /* Style for Card Titles with Count */
        .card-title-with-count {
            font-weight: bold; /* Optional: Make the title stand out */
        }

        /* --- 新增：移除证券代码链接下划线 (使用类名) --- */
        /* 移除持仓列表和当日委托列表中证券代码链接的下划线 */
        .stock-code-link {
            text-decoration: none;
        }

        /* ----------------------------- */
        /* --- 新增：资金持仓 样式优化 --- */

        /* 针对资金持仓模块的字段名 */
        #collapseContent .form-label {
            font-size: 15px;
        }

        /* 针对资金持仓模块的字段值 */
        #collapseContent .form-control {
            font-size: 15px;
            background-color: #f8f9fa; /* 浅灰色背景 */
            /* 注意：覆盖 .form-control 的样式需要足够 specificity 或使用 !important (不推荐) */
        }

        /* --- 新增：一键取款 样式优化 --- */
        /* 调整模态框大小和内边距 */
        #quickLowerFinancingModal .modal-dialog {
            max-width: 500px; /* 设置最大宽度 */
            margin: 1rem auto; /* 增加上下边距 */
        }

        #quickLowerFinancingModal .modal-content {
            border-radius: 8px; /* 圆角 */
            box-shadow: 0 0.15rem 1rem rgba(0, 0, 0, 0.15); /* 添加阴影 */
        }

        /* 优化字段名和字段值的样式 */
        #quickLowerFinancingModal .modal-body .form-label {
            font-weight: 600; /* 加粗 */
            color: #007bff; /* 颜色 */
            font-size: 16px; /* 增大字号 */
        }

        /* 字段值 (数值) - 使用标准字体和颜色 */
        #quickLowerFinancingModal .modal-body span {
            font-weight: 500; /* 半加粗 */
            color: red; /* 颜色 */
            font-size: 16px; /* 增大字号 */
        }

        /* 输入框样式 */
        #quickLowerFinancingModal .form-control {
            color: #007bff; /* 颜色 */
            font-size: 20px; /* 增大输入框内文字大小 */
            height: calc(1.5em + 1rem + 2px); /* 略微增大输入框高度 */
            border-radius: 6px; /* 更圆润的边角 */
        }

        /* --- 新增：一键卖出设置模态框样式 --- */
        #sellSettingsModal .modal-dialog {
            max-width: 500px;
            margin: 1rem auto;
        }

        #sellSettingsModal .modal-content {
            border-radius: 8px;
            box-shadow: 0 0.15rem 1rem rgba(0, 0, 0, 0.15);
        }

        #sellSettingsModal .modal-body .form-label {
            font-weight: 600;
            color: #007bff;
            font-size: 16px;
        }

        #sellSettingsModal .form-control {
            font-size: 16px;
            height: calc(1.5em + 0.75rem + 2px);
            border-radius: 6px;
        }

        #sellSettingsModal .price-strategy-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        #sellSettingsModal .price-strategy-option input[type="radio"] {
            margin-right: 5px;
        }

        #sellSettingsModal .price-strategy-option input[type="number"] {
            width: 100px;
            margin-left: 10px;
            padding: 2px 5px;
            font-size: 14px;
        }

        #sellSettingsModal .price-strategy-option span {
            margin-left: 5px;
        }

        /* --- 新增：持仓账户配置模块样式 --- */
        #cfgAccountForm .form-label {
            font-size: 15px;
            font-weight: 500;
        }

        #cfgAccountForm .form-control {
            font-size: 15px;
        }

        #cfgAccountForm .form-check-label {
            font-size: 15px;
        }

        /* --- 新增：为可折叠的 Card Header 添加手型光标 --- */
        .collapsible-card-header {
            cursor: pointer;
        }

        .collapsible-card-header .collapse-btn {
            font-size: 0.8rem;
            color: #6c757d; /* Bootstrap text-muted color */
        }

        /* --- 新增：为折叠内容添加过渡动画 --- */
        .collapsible-content {
            transition: all 0.3s ease;
        }

        /* --- 主线个股/主线个股 相关样式 --- */
        .top-stock-indicator {
            background-color: #ffeb3b; /* 黄色背景 */
            color: #333; /* 深色文字 */
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            font-size: 11px;
        }

        .top-block-list {
            font-size: 11px; /* 更小的字体 */
            text-align: left; /* 左对齐 */
            line-height: 1.2; /* 紧凑行高 */
        }

        .top-block-list div {
            margin: 1px 0; /* 块之间的小间距 */
        }

        /* --- 新增：主线板块/主线个股 列表样式 --- */
        .top-list-item {
            font-size: 12px;
        }

        .top-list-item div {
            margin: 1px 0;
        }


        /* ----------------------------- */


        /* 平均值行 */

        .avg-row {
            background-color: #dee2e6;
            font-weight: bold;
            font-style: italic;
            border-top: 2px solid #dee2e6;
        }

        /* 针对平均值行中所有单元格的样式 */
        .avg-row td {
            background-color: #dee2e6;
            border: 1px solid #adb5bd; /* 显式设置一个比背景色深的边框颜色，确保列分隔线可见 */
            padding: 4px 6px;
        }

        /* 针对平均值行中合并列的标签单元格样式 */
        .avg-row .avg-label {
            background-color: #dee2e6;
            font-size: 0.9em;
            padding: 5px 10px;
            text-align: center;
            border: 1px solid #adb5bd;
        }


        /* ----------------------------- */


        /* === 修复 持仓列表 水平滚动问题 === */

        /* 1. 强化容器 */
        #positionTableContainer {
            overflow-x: auto;
            min-width: 100%;
            padding: 0;
            margin: 0;
            padding-bottom: 5px;
            background-color: #fff;
        }

        /* 2. 解除父容器限制 */
        .card-body {
            overflow-x: visible !important;
            max-width: none !important;
            width: auto !important;
        }

        /* 3. 优化表格 */
        #positionTable th,
        #positionTable td {
            white-space: nowrap;
        }

        /* 4. 固定表头 (可选) */
        #positionTable thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }


        /* --- 新增：扩大页面整体宽度 --- */
        .container {
            min-width: 75%;
            max-width: 85%; /* 全屏宽度的 85% */
            width: 100%; /* 确保在小于 max-width 时能自适应 */
        }


    </style>
</head>
<body>
<div class="container mt-4">
    <h2>我的持仓</h2>
    <!-- 资金持仓表单 (保持不动) -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center" onclick="toggleCollapse()">
            <span>资金持仓</span>
            <span class="collapse-btn" onclick="toggleCollapse()">展开/折叠</span>
        </div>
        <div class="card-body collapse-content" id="collapseContent">
            <form>
                <div class="row">
                    <div class="col-md-4">
                        <label for="totalAsset" class="form-label">总资产</label>
                        <input type="text" class="form-control" id="totalAsset" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="totalMktVal" class="form-label">总市值</label>
                        <input type="text" class="form-control" id="totalMktVal" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="accessMoney" class="form-label">可取资金</label>
                        <input type="text" class="form-control" id="accessMoney" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="profit" class="form-label">持仓盈亏</label>
                        <input type="text" class="form-control" id="profit" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="curProfit" class="form-label">当日盈亏</label>
                        <input type="text" class="form-control" id="curProfit" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="posRatio" class="form-label">总仓位</label>
                        <input type="text" class="form-control" id="posRatio" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="netAsset" class="form-label">净资产</label>
                        <input type="text" class="form-control" id="netAsset" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="totalLiability" class="form-label">总负债</label>
                        <input type="text" class="form-control" id="totalLiability" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="marginAvl" class="form-label">可用保证金（可融）</label>
                        <input type="text" class="form-control" id="marginAvl" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="marginRates" class="form-label">维持担保比例</label>
                        <input type="text" class="form-control" id="marginRates" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="ftotaldebts" class="form-label">融资负债</label>
                        <input type="text" class="form-control" id="ftotaldebts" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="avalmoney" class="form-label">可用资金（担）</label>
                        <input type="text" class="form-control" id="avalmoney" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="realrate" class="form-label">实时担保比例</label>
                        <input type="text" class="form-control" id="realrate" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="dtotaldebts" class="form-label">融券负债</label>
                        <input type="text" class="form-control" id="dtotaldebts" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="acreditavl" class="form-label">剩余额度</label>
                        <input type="text" class="form-control" id="acreditavl" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="holdingStockCount" class="form-label">持仓个股</label>
                        <input type="text" class="form-control" id="holdingStockCount" readonly>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- 新增：配置-持仓账户 模块 -->
    <div class="card mb-4">
        <!-- 添加 ID 和 Class 用于折叠控制 -->
        <div class="card-header d-flex justify-content-between align-items-center collapsible-card-header"
             id="cfgAccountCardHeader" onclick="toggleCfgAccountCollapse()">
            <span>配置-持仓账户</span>
            <!-- 添加 折叠/展开 按钮/指示器 -->
            <span class="collapse-btn" id="cfgAccountCollapseBtn"></span>
            <button type="button" class="btn btn-primary" id="saveCfgAccountBtn"
                    style="font-size: 12px; padding: 2px 8px; border: 1px solid blue; display: none;">
                保存
            </button>
        </div>
        <!-- 添加 ID 和 Class 用于折叠内容，并设置默认隐藏 -->
        <div class="card-body collapse-content collapsible-content" id="cfgAccountCollapseContent"
             style="display: none;">
            <form id="cfgAccountForm">
                <div class="row mb-3">
                    <div class="col-md-12 mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="rzAccountCheckbox" role="switch">
                            <label class="form-check-label" for="rzAccountCheckbox">可融资</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="maxRzPctInput" class="form-label">最大融资比例（1~2.5）</label>
                        <input type="number" class="form-control" id="maxRzPctInput" step="0.01" min="1" max="2.5">
                    </div>
                    <div class="col-md-4">
                        <label for="posLimitPctInput" class="form-label">账户-持仓上限（%）</label>
                        <input type="number" class="form-control" id="posLimitPctInput" step="0.1" min="0" max="100">
                    </div>
                    <div class="col-md-4">
                        <label for="stockPosLimitPctInput" class="form-label">单只个股-持仓上限（%）</label>
                        <input type="number" class="form-control" id="stockPosLimitPctInput" step="0.1" min="0"
                               max="25">
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- 查询按钮 & 一键等比卖出 & 新增按钮 -->
    <div class="d-flex align-items-center mb-3 flex-wrap">
        <button id="loadPositionsButton" class="btn btn-primary">查询</button>
        <button id="sellPositionsButton" class="btn btn-danger ms-3">一键等比卖出</button>
        <!-- 新增：一键再融资按钮 -->
        <button id="quickResetFinancingButton" class="btn btn-warning ms-3">一键再融资</button>
        <!-- 新增：一键取款按钮 -->
        <button id="quickLowerFinancingButton" class="btn btn-info ms-3">一键取款</button>
        <!-- 新增：一键等比买入按钮 -->
        <button id="buyNewPositionButton" class="btn btn-success ms-3">一键等比买入（调仓换股）</button>
    </div>
    <!-- Add Tabs Navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <!-- 我的持仓 -->
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions"
                    type="button" role="tab" aria-controls="positions" aria-selected="true">我的持仓
            </button>
        </li>
        <!-- 当日委托 -->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders"
                    type="button" role="tab" aria-controls="orders" aria-selected="false">当日委托
            </button>
        </li>
        <!-- 主线板块（机选）-->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="top-blocks-tab" data-bs-toggle="tab" data-bs-target="#top-blocks"
                    type="button" role="tab" aria-controls="top-blocks" aria-selected="false">主线板块（机选）
            </button>
        </li>
        <!-- 主线个股（机选）-->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="top-stocks-tab" data-bs-toggle="tab" data-bs-target="#top-stocks"
                    type="button" role="tab" aria-controls="top-stocks" aria-selected="false">主线个股（机选）
            </button>
        </li>
        <!-- 主线板块（人选）-->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="top-blocks-manual-tab" data-bs-toggle="tab" data-bs-target="#top-blocks-manual"
                    type="button" role="tab" aria-controls="top-blocks-manual" aria-selected="false">主线板块（人选）
            </button>
        </li>
        <!-- 主线个股（人选）-->
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="top-stocks-manual-tab" data-bs-toggle="tab" data-bs-target="#top-stocks-manual"
                    type="button" role="tab" aria-controls="top-stocks-manual" aria-selected="false">主线个股（人选）
            </button>
        </li>
    </ul>
    <!-- Tab Content -->
    <div class="tab-content" id="myTabContent">
        <!-- My Positions Tab Content -->
        <div class="tab-pane fade show active" id="positions" role="tabpanel" aria-labelledby="positions-tab">
            <!-- 持仓详情 -->
            <div class="card mt-3">
                <!-- Modified: 使用 span 包含标题，以便动态更新 -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="positionsCardTitle" class="card-title-with-count">持仓详情</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive" id="positionTableContainer">
                        <table class="table table-bordered table-sm" id="positionTable">
                            <thead>
                            <tr>
                                <th><input type="checkbox" id="positionSelectAllCheckboxHeader">勾选</th>
                                <th>序号</th>
                                <th onclick="sortPositionsTable('stkcode')">证券代码<span class="sort-icon"
                                                                                          id="sortStkcode"></span></th>
                                <th onclick="sortPositionsTable('stkname')">证券名称<span class="sort-icon"
                                                                                          id="sortStkname"></span></th>
                                <th onclick="sortPositionsTable('market')">市场<span class="sort-icon"
                                                                                     id="sortMarket"></span>
                                </th>
                                <th onclick="sortPositionsTable('costprice')">成本价<span class="sort-icon"
                                                                                          id="sortCostprice"></span>
                                </th>
                                <th onclick="sortPositionsTable('preClose')">昨收<span class="sort-icon"
                                                                                       id="sortPreClose"></span>
                                </th>
                                <th onclick="sortPositionsTable('lastprice')">最新价<span class="sort-icon"
                                                                                          id="sortLastprice"></span>
                                </th>
                                <th onclick="sortPositionsTable('mktval')">市值<span class="sort-icon"
                                                                                     id="sortMktval"></span>
                                </th>
                                <th onclick="sortPositionsTable('profit')">持仓盈亏<span class="sort-icon"
                                                                                         id="sortProfit"></span></th>
                                <th onclick="sortPositionsTable('profitratio')">持仓盈亏比例<span class="sort-icon"
                                                                                                  id="sortProfitratio"></span>
                                </th>
                                <th onclick="sortPositionsTable('curprofit')">当日盈亏<span class="sort-icon"
                                                                                            id="sortCurprofit"></span>
                                </th>
                                <th onclick="sortPositionsTable('curProfitratio')">当日盈亏比例<span class="sort-icon"
                                                                                                     id="sortCurProfitratio"></span>
                                </th>
                                <th onclick="sortPositionsTable('posratio')">仓位占比<span class="sort-icon"
                                                                                           id="sortPosratio"></span>
                                </th>
                                <th onclick="sortPositionsTable('stkbal')">持仓数量<span class="sort-icon"
                                                                                         id="sortStkbal"></span></th>
                                <th onclick="sortPositionsTable('stkavl')">可用数量<span class="sort-icon"
                                                                                         id="sortStkavl"></span></th>
                                <th onclick="sortPositionsTable('industry')">行业<span class="sort-icon"
                                                                                       id="sortIndustry"></span></th>
                                <th onclick="sortPositionsTable('topStock')">主线个股<span class="sort-icon"
                                                                                           id="sortTopStock"></span>
                                </th>
                                <th onclick="sortPositionsTable('inTopBlock')">IN主线板块<span class="sort-icon"
                                                                                               id="sortInTopBlock"></span>
                                </th>
                                <th>主线板块</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- 当日委托 Tab Content -->
        <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
            <div class="card mt-3">
                <!-- Modified: 使用 span 包含标题，以便动态更新 -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="ordersCardTitle" class="card-title-with-count">当日委托列表</span>
                    <div class="d-flex align-items-center flex-wrap" id="orders-action-controls">
                        <!-- 新增的按钮区域 -->
                        <button id="batchCancelOrdersButton" class="btn btn-warning btn-sm">批量撤单</button>
                        <button id="quickCancelOrdersButton" class="btn btn-danger btn-sm ms-2">一键撤单</button>
                    </div>
                </div>
                <div class="card-header d-flex justify-content-between align-items-center mt-2"> <!-- 新增一行用于筛选 -->
                    <div class="d-flex align-items-center flex-wrap" id="orders-filter-controls">
                        <!-- 筛选条件 -->
                        <div class="d-flex align-items-center me-3">
                            <label for="filterStatus">委托状态:</label>
                            <select id="filterStatus" class="form-select form-select-sm" style="width:auto">
                                <option value="">全部</option>
                                // 已成交 -> 已撤/已成/废单
                                // 未成交 -> 未报/已报/部成
                                <option value="未成交">未成交</option>
                                <option value="已成交">已成交</option>
                                <option value="已成">已成</option>
                                <option value="部成">部成</option>
                                <option value="已报">已报</option>
                                <option value="未报">未报</option>
                                <option value="已撤">已撤</option>
                                <option value="废单">废单</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label for="filterDirection">委托方向:</label>
                            <select id="filterDirection" class="form-select form-select-sm" style="width:auto">
                                <option value="">全部</option>
                                <option value="证券买入">证券买入</option>
                                <option value="证券卖出">证券卖出</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label for="ordersStartDateInput" class="me-2">查询日期：</label>
                            <input type="date" id="ordersStartDateInput" class="form-control form-control-sm me-2"
                                   style="width: auto;" min="1990-01-01" max="">
                            <label for="ordersEndDateInput" class="me-2"> ~ </label>
                            <input type="date" id="ordersEndDateInput" class="form-control form-control-sm me-2"
                                   style="width: auto;" min="1990-01-01" max="">
                        </div>
                        <button id="refreshOrdersButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="ordersTable">
                            <thead>
                            <tr>
                                <th><input type="checkbox" id="ordersSelectAllCheckboxHeader">勾选</th>
                                <th onclick="sortOrdersTable('wtbh')">委托编号<span class="sort-icon"
                                                                                    id="sortWtbh"></span></th>
                                <th onclick="sortOrdersTable('wtrq')">委托日期<span class="sort-icon"
                                                                                    id="sortWtrq"></span></th>
                                <th onclick="sortOrdersTable('wtsj')">委托时间<span class="sort-icon"
                                                                                    id="sortwtsj"></span></th>
                                <th onclick="sortOrdersTable('zqdm')">证券代码<span class="sort-icon"
                                                                                    id="sortZqdm"></span></th>
                                <th onclick="sortOrdersTable('zqmc')">证券名称<span class="sort-icon"
                                                                                    id="sortZqmc"></span></th>
                                <th onclick="sortOrdersTable('mmsm')">委托方向<span class="sort-icon"
                                                                                    id="sortMmsm"></span></th>
                                <th onclick="sortOrdersTable('wtzt')">委托状态<span class="sort-icon"
                                                                                    id="sortWtzt"></span></th>
                                <th onclick="sortOrdersTable('wtjg')">委托价格<span class="sort-icon"
                                                                                    id="sortWtjg"></span></th>
                                <th onclick="sortOrdersTable('wtsl')">委托数量<span class="sort-icon"
                                                                                    id="sortWtsl"></span></th>
                                <th onclick="sortOrdersTable('wtje')">委托金额<span class="sort-icon"
                                                                                    id="sortWtje"></span></th>
                                <th onclick="sortOrdersTable('posPct')">仓位占比(%)<span class="sort-icon"
                                                                                         id="sortPosPct"></span></th>
                                <th onclick="sortOrdersTable('cjjg')">成交价格<span class="sort-icon"
                                                                                    id="sortCjjg"></span></th>
                                <th onclick="sortOrdersTable('cjsl')">成交数量<span class="sort-icon"
                                                                                    id="sortCjsl"></span></th>
                                <th onclick="sortOrdersTable('cjje')">成交金额<span class="sort-icon"
                                                                                    id="sortCjje"></span></th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="ordersTableMessage" class="text-center text-muted mt-3">暂无委托记录</div>
                    <!-- Message placeholder -->
                </div>
            </div>
        </div>

        <!-- 新增：主线板块 Tab Content -->
        <div class="tab-pane fade" id="top-blocks" role="tabpanel" aria-labelledby="top-blocks-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="topBlocksCardTitle" class="card-title-with-count">主线板块列表</span>
                    <!-- 新增：日期选择和刷新按钮区域 -->
                    <div class="d-flex align-items-center flex-wrap">
                        <label for="topBlocksDateInput" class="me-2">日期:</label>
                        <input type="date" id="topBlocksDateInput" class="form-control form-control-sm me-2"
                               style="width: auto;" min="1990-01-01" max="">
                        <button id="refreshTopBlocksButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-header d-flex justify-content-between align-items-center mt-2"> <!-- 新增一行用于筛选 -->
                    <div class="d-flex align-items-center flex-wrap" id="top-blocks-filter-controls">
                        <!-- 可以在此处添加针对主线板块的筛选控件 -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="topBlocksTable">
                            <thead>
                            <tr>
                                <th onclick="sortTopBlocksTable('rank')">序号<span class="sort-icon"
                                                                                   id="sortTopBlocksRank"></span></th>
                                <th onclick="sortTopBlocksTable('blockCode')">板块代码<span class="sort-icon"
                                                                                            id="sortTopBlocksBlockCode"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('blockName')">板块名称<span class="sort-icon"
                                                                                            id="sortTopBlocksBlockName"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('topDays')">上榜天数<span class="sort-icon"
                                                                                          id="sortTopBlocksTopDays"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('topStockSize')">主线个股数量<span class="sort-icon"
                                                                                                   id="sortTopBlocksTopStockSize"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('topStockList')">主线个股<span class="sort-icon"
                                                                                               id="sortTopBlocksTopStockList"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('topStartDate')">首次上榜日期<span class="sort-icon"
                                                                                                   id="sortTopBlocksTopStartDate"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('topEndDate')">跌出榜单日期<span class="sort-icon"
                                                                                                 id="sortTopBlocksTopEndDate"></span>
                                </th>
                                <th onclick="sortTopBlocksTable('start2Today_changePct')">上榜至今涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Today_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2End_changePct')">上榜至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2End_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Max_changePct')">上榜至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Max_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('today2Next_changePct')">今日至nextDay涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksToday2Next_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('today2End_changePct')">今日至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksToday2End_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('today2Max_changePct')">今日至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksToday2Max_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next_changePct')">上榜至N1涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next3_changePct')">上榜至N3涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next3_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next5_changePct')">上榜至N5涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next5_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next10_changePct')">上榜至N10涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next10_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next15_changePct')">上榜至N15涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next15_changePct"></span></th>
                                <th onclick="sortTopBlocksTable('start2Next20_changePct')">上榜至N20涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksStart2Next20_changePct"></span></th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="topBlocksTableMessage" class="text-center text-muted mt-3">暂无数据</div>
                </div>
            </div>
        </div>

        <!-- 新增：主线个股 Tab Content -->
        <div class="tab-pane fade" id="top-stocks" role="tabpanel" aria-labelledby="top-stocks-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="topStocksCardTitle" class="card-title-with-count">主线个股列表</span>
                    <!-- 新增：日期选择和刷新按钮区域 -->
                    <div class="d-flex align-items-center flex-wrap">
                        <label for="topStocksDateInput" class="me-2">日期:</label>
                        <input type="date" id="topStocksDateInput" class="form-control form-control-sm me-2"
                               style="width: auto;" min="1990-01-01" max="">
                        <button id="refreshTopStocksButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-header d-flex justify-content-between align-items-center mt-2"> <!-- 新增一行用于筛选 -->
                    <div class="d-flex align-items-center flex-wrap" id="top-stocks-filter-controls">
                        <!-- 可以在此处添加针对主线个股的筛选控件 -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="topStocksTable">
                            <thead>
                            <tr>
                                <th onclick="sortTopStocksTable('rank')">序号<span class="sort-icon"
                                                                                   id="sortTopStocksRank"></span></th>
                                <th onclick="sortTopStocksTable('stockCode')">股票代码<span class="sort-icon"
                                                                                            id="sortTopStocksStockCode"></span>
                                </th>
                                <th onclick="sortTopStocksTable('stockName')">股票名称<span class="sort-icon"
                                                                                            id="sortTopStocksStockName"></span>
                                </th>
                                <th onclick="sortTopStocksTable('topDays')">上榜天数<span class="sort-icon"
                                                                                          id="sortTopStocksDays"></span>
                                </th>
                                <th onclick="sortTopStocksTable('topBlockSize')">所属主线板块数量<span class="sort-icon"
                                                                                                       id="sortTopStocksTopBlockSize"></span>
                                </th>
                                <th onclick="sortTopStocksTable('topBlockList')">所属主线板块<span class="sort-icon"
                                                                                                   id="sortTopStocksTopBlockList"></span>
                                </th>
                                <th onclick="sortTopStocksTable('topStartDate')">首次上榜日期<span class="sort-icon"
                                                                                                   id="sortTopStocksTopStartDate"></span>
                                </th>
                                <th onclick="sortTopStocksTable('topEndDate')">跌出榜单日期<span class="sort-icon"
                                                                                                 id="sortTopStocksTopEndDate"></span>
                                </th>
                                <th onclick="sortTopStocksTable('start2Today_changePct')">上榜至今涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Today_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2End_changePct')">上榜至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2End_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Max_changePct')">上榜至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Max_changePct"></span></th>
                                <th onclick="sortTopStocksTable('today2Next_changePct')">今日至nextDay涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksToday2Next_changePct"></span></th>
                                <th onclick="sortTopStocksTable('today2End_changePct')">今日至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksToday2End_changePct"></span></th>
                                <th onclick="sortTopStocksTable('today2Max_changePct')">今日至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksToday2Max_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next_changePct')">上榜至N1涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next3_changePct')">上榜至N3涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next3_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next5_changePct')">上榜至N5涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next5_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next10_changePct')">上榜至N10涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next10_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next15_changePct')">上榜至N15涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next15_changePct"></span></th>
                                <th onclick="sortTopStocksTable('start2Next20_changePct')">上榜至N20涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksStart2Next20_changePct"></span></th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="topStocksTableMessage" class="text-center text-muted mt-3">暂无数据</div>
                </div>
            </div>
        </div>

        <!-- 新增：主线板块 Tab Content (人选) -->
        <div class="tab-pane fade" id="top-blocks-manual" role="tabpanel" aria-labelledby="top-blocks-manual-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="topBlocksManualCardTitle" class="card-title-with-count">主线板块列表</span>
                    <!-- 新增：日期选择和刷新按钮区域 -->
                    <div class="d-flex align-items-center flex-wrap">
                        <label for="topBlocksManualDateInput" class="me-2">日期:</label>
                        <input type="date" id="topBlocksManualDateInput" class="form-control form-control-sm me-2"
                               style="width: auto;" min="1990-01-01" max="">
                        <button id="refreshTopBlocksManualButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-header d-flex justify-content-between align-items-center mt-2"> <!-- 新增一行用于筛选 -->
                    <div class="d-flex align-items-center flex-wrap" id="top-blocks-manual-filter-controls">
                        <!-- 可以在此处添加针对主线板块的筛选控件 -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="topBlocksTableManual">
                            <thead>
                            <tr>
                                <th onclick="sortTopBlocksTableManual('rank')">序号<span class="sort-icon"
                                                                                         id="sortTopBlocksManualRank"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('blockCode')">板块代码<span class="sort-icon"
                                                                                                  id="sortTopBlocksManualBlockCode"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('blockName')">板块名称<span class="sort-icon"
                                                                                                  id="sortTopBlocksManualBlockName"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('topDays')">上榜天数<span class="sort-icon"
                                                                                                id="sortTopBlocksManualTopDays"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('topStockSize')">主线个股数量<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualTopStockSize"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('topStockList')">主线个股<span class="sort-icon"
                                                                                                     id="sortTopBlocksManualTopStockList"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('topStartDate')">首次上榜日期<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualTopStartDate"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('topEndDate')">跌出榜单日期<span class="sort-icon"
                                                                                                       id="sortTopBlocksManualTopEndDate"></span>
                                </th>
                                <th onclick="sortTopBlocksTableManual('start2Today_changePct')">上榜至今涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Today_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2End_changePct')">上榜至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2End_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Max_changePct')">上榜至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Max_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('today2Next_changePct')">今日至nextDay涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualToday2Next_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('today2End_changePct')">今日至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualToday2End_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('today2Max_changePct')">今日至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualToday2Max_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next_changePct')">上榜至N1涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next3_changePct')">上榜至N3涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next3_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next5_changePct')">上榜至N5涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next5_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next10_changePct')">上榜至N10涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next10_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next15_changePct')">上榜至N15涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next15_changePct"></span></th>
                                <th onclick="sortTopBlocksTableManual('start2Next20_changePct')">上榜至N20涨幅<span
                                        class="sort-icon"
                                        id="sortTopBlocksManualStart2Next20_changePct"></span></th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="topBlocksTableManualMessage" class="text-center text-muted mt-3">暂无数据</div>
                </div>
            </div>
        </div>

        <!-- 新增：主线个股 Tab Content (人选) -->
        <div class="tab-pane fade" id="top-stocks-manual" role="tabpanel" aria-labelledby="top-stocks-manual-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="topStocksManualCardTitle" class="card-title-with-count">主线个股列表</span>
                    <button id="batchDeleteTopStocksManualButton" class="btn btn-danger btn-sm ms-2">批量删除</button>
                    <!-- 新增：日期选择和刷新按钮区域 -->
                    <div class="d-flex align-items-center flex-wrap">
                        <label for="topStocksManualDateInput" class="me-2">日期:</label>
                        <input type="date" id="topStocksManualDateInput" class="form-control form-control-sm me-2"
                               style="width: auto;" min="1990-01-01">
                        <button id="refreshTopStocksManualButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-header d-flex justify-content-between align-items-center mt-2"> <!-- 新增一行用于筛选 -->
                    <div class="d-flex align-items-center flex-wrap" id="top-stocks-manual-filter-controls">
                        <!-- 可以在此处添加针对主线个股的筛选控件 -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="topStocksTableManual">
                            <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="topStocksManualSelectAllCheckboxHeader"
                                           class="select-all-checkbox-top-stocks-manual" title="全选/取消全选">勾选
                                </th>
                                <th onclick="sortTopStocksTableManual('rank')">序号<span class="sort-icon"
                                                                                         id="sortTopStocksManualRank"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('stockCode')">股票代码<span class="sort-icon"
                                                                                                  id="sortTopStocksManualStockCode"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('stockName')">股票名称<span class="sort-icon"
                                                                                                  id="sortTopStocksManualStockName"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('topDays')">上榜天数<span class="sort-icon"
                                                                                                id="sortTopStocksManualDays"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('topBlockSize')">所属主线板块数量<span
                                        class="sort-icon"
                                        id="sortTopStocksManualTopBlockSize"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('topBlockList')">所属主线板块<span
                                        class="sort-icon"
                                        id="sortTopStocksManualTopBlockList"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('topStartDate')">首次上榜日期<span
                                        class="sort-icon"
                                        id="sortTopStocksManualTopStartDate"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('topEndDate')">跌出榜单日期<span class="sort-icon"
                                                                                                       id="sortTopStocksManualTopEndDate"></span>
                                </th>
                                <th onclick="sortTopStocksTableManual('start2Today_changePct')">上榜至今涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Today_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2End_changePct')">上榜至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2End_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Max_changePct')">上榜至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Max_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('today2Next_changePct')">今日至nextDay涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualToday2Next_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('today2End_changePct')">今日至跌出涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualToday2End_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('today2Max_changePct')">今日至MAX涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualToday2Max_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next_changePct')">上榜至N1涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next3_changePct')">上榜至N3涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next3_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next5_changePct')">上榜至N5涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next5_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next10_changePct')">上榜至N10涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next10_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next15_changePct')">上榜至N15涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next15_changePct"></span></th>
                                <th onclick="sortTopStocksTableManual('start2Next20_changePct')">上榜至N20涨幅<span
                                        class="sort-icon"
                                        id="sortTopStocksManualStart2Next20_changePct"></span></th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="topStocksTableManualMessage" class="text-center text-muted mt-3">暂无数据</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- --- 新增：一键等比卖出 设置模态框 --- -->
<div class="modal fade" id="sellSettingsModal" tabindex="-1" aria-labelledby="sellSettingsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sellSettingsModalLabel">一键等比卖出</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modalSellPercentageInput" class="form-label">卖出仓位比例:</label>
                    <input type="number" class="form-control" id="modalSellPercentageInput" value="100" min="0"
                           max="100" step="1">
                    <div class="form-text">请输入 0 到 100 之间的数值</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">价格策略:</label>
                    <div class="price-strategy-option">
                        <input type="radio" id="modalStrategyCurrPrice" name="modalPriceStrategy" value="currPricePct"
                               checked>
                        <label for="modalStrategyCurrPrice">当前价格</label>
                        <input type="number" id="modalCurrPricePctInput" class="form-control form-control-sm" value="0"
                               min="-30" max="30" step="0.1" disabled>
                        <span>%</span>
                    </div>
                    <div class="price-strategy-option">
                        <input type="radio" id="modalStrategyChangePrice" name="modalPriceStrategy"
                               value="changePricePct">
                        <label for="modalStrategyChangePrice">昨日收盘价</label>
                        <input type="number" id="modalChangePricePctInput" class="form-control form-control-sm"
                               value="0" min="-30" max="30" step="0.1" disabled>
                        <span>%</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmSellSettingsBtn">确认卖出</button>
            </div>
        </div>
    </div>
</div>
<!-- --- 结束：一键等比卖出 设置模态框 --- -->

<!-- --- 新增：一键取款 模态框 --- -->
<div class="modal fade" id="quickLowerFinancingModal" tabindex="-1" aria-labelledby="quickLowerFinancingModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickLowerFinancingModalLabel">一键取款</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <p>当前净资产：<span id="currentNetAsset">0.00</span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <p>建议取款金额（净资产10%）：<span id="suggestedAmount">0.00</span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <p>最大可取金额：<span id="maxTransferAmount">0.00</span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="transferAmountInputModal"
                               class="form-label"><strong>请输入取款金额：</strong></label>
                        <input type="number" class="form-control" id="transferAmountInputModal" min="0" step="100"
                               required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmQuickLowerFinancingBtn">确认</button>
            </div>
        </div>
    </div>
</div>
<!-- --- 结束：一键取款 模态框 --- -->

<!-- - 新增：一键等比买入 设置模态框 - -->
<div class="modal fade" id="buyNewPositionSettingsModal" tabindex="-1"
     aria-labelledby="buyNewPositionSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyNewPositionSettingsModalLabel">一键等比买入（调仓换股）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modalBuyPosPctInput" class="form-label">买入总仓位比例 (%):</label>
                    <input type="number" class="form-control" id="modalBuyPosPctInput" value="100" min="0" max="100"
                           step="1" required>
                    <div class="form-text">请输入 0 到 100 之间的数值 (例如: 100 表示满仓买入选中股票)</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">价格策略:</label>
                    <div class="price-strategy-option">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="modalBuyPriceStrategy"
                                   id="modalStrategyBuyCurrPrice" value="currPricePct" checked>
                            <label class="form-check-label" for="modalStrategyBuyCurrPrice">按当前价格涨跌幅%</label>
                        </div>
                        <div class="input-group mt-1">
                            <input type="number" class="form-control" id="modalBuyCurrPricePctInput" value="0" min="-30"
                                   max="30" step="0.1" placeholder="例如: -1.0 表示挂单价格为当前价的 99%">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="price-strategy-option mt-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="modalBuyPriceStrategy"
                                   id="modalStrategyBuyChangePrice" value="changePricePct">
                            <label class="form-check-label"
                                   for="modalStrategyBuyChangePrice">按昨日收盘价涨跌幅%</label>
                        </div>
                        <div class="input-group mt-1">
                            <input type="number" class="form-control" id="modalBuyChangePricePctInput" value="0"
                                   min="-30" max="30" step="0.1" placeholder="例如: -1.0 表示挂单价格为昨收价的 99%">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBuyNewPositionSettingsBtn">确认买入</button>
            </div>
        </div>
    </div>
</div>
<!-- - 结束：一键等比买入 设置模态框 - -->


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 存储排序状态 (持仓)
    let sortState = {column: 'mktval', order: 'desc'};
    let positionsData = [];
    // 存储排序状态 (委托)
    let ordersSortState = {column: null, order: 'asc'};
    let ordersData = [];
    // 存储持仓账户配置数据
    let cfgAccountData = {
        id: null,
        rzAccount: 0,
        maxRzPct: 0,
        posLimitPct: 0,
        stockPosLimitPct: 0
    };

    // --- 通用函数 ---
    function market2Xueqiu(market) {
        return market === "SA" ? "SZ" : market === "HA" ? "SH" : "BJ";
    }

    // --- 新增：主线板块/个股数据 (机选) ---
    let topBlocksData = [];
    let topStocksData = [];
    let topBlockAvgPctData = {};
    let topStockAvgPctData = {};
    // 存储排序状态 (主线板块)
    let topBlocksSortState = {column: 'topStockSize', order: 'desc'}; // 默认按topStockSize倒序
    // 存储排序状态 (主线个股)
    let topStocksSortState = {column: 'topBlockSize', order: 'desc'}; // 默认按topBlockSize倒序


    // - 新增：主线板块/个股数据 (人选) -
    let topBlocksDataManual = [];
    let topStocksDataManual = [];
    let topBlockAvgPctDataManual = {};
    let topStockAvgPctDataManual = {};
    // 存储排序状态 (主线板块 人选)
    let topBlocksSortStateManual = {column: 'topStockSize', order: 'desc'}; // 默认按topStockSize倒序
    // 存储排序状态 (主线个股 人选)
    let topStocksSortStateManual = {column: 'topBlockSize', order: 'desc'}; // 默认按topBlockSize倒序


    // 使用 toLocaleDateString 获取本地日期字符串，并指定格式
    // 'zh-CN' 是中国地区代码，'en-CA' 也能返回 YYYY-MM-DD 格式
    // { timeZone: 'Asia/Shanghai' } 明确指定时区，更可靠
    const today = new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Shanghai'});

    // 委托单
    let ordersStartDate = today; // 默认为今天
    let ordersEndDate = today;   // 默认为今天

    // - 新增：主线板块/个股当前日期 (机选) -
    let topBlocksCurrentDate = today; // 默认为今天
    let topStocksCurrentDate = today; // 默认为今天
    // - 新增：主线板块/个股当前日期 (人选) -
    let topBlocksCurrentDateManual = today; // 默认为今天
    let topStocksCurrentDateManual = today; // 默认为今天


    // ----------------------------------------- 一键 B/S 快捷按钮 -------------------------------------------------------


    // ----------   一键等比卖出


    // 一键卖出功能 (弹框设置)

    // 1. 主按钮：打开 价格策略
    function handleSellPositions() {
        const selectedCheckboxes = document.querySelectorAll('.sell-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一只股票进行卖出！');
            return;
        }
        // 重置模态框内的输入
        document.getElementById('modalSellPercentageInput').value = '100';
        document.getElementById('modalCurrPricePctInput').value = '0';
        document.getElementById('modalChangePricePctInput').value = '0';
        document.getElementById('modalStrategyCurrPrice').checked = true;
        document.getElementById('modalStrategyChangePrice').checked = false;
        // 初始化模态框内价格策略输入框状态
        updateModalInputStates();
        // 显示模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('sellSettingsModal'));
        if (modal) {
            modal.show();
        } else {
            new bootstrap.Modal(document.getElementById('sellSettingsModal')).show();
        }
    }

    // 2. 价格策略（互斥）
    function updateModalInputStates() {
        const strategyCurrPrice = document.getElementById('modalStrategyCurrPrice');
        const strategyChangePrice = document.getElementById('modalStrategyChangePrice');
        const currPricePctInput = document.getElementById('modalCurrPricePctInput');
        const changePricePctInput = document.getElementById('modalChangePricePctInput');

        if (strategyCurrPrice.checked) {
            currPricePctInput.disabled = false;
            changePricePctInput.disabled = true;
            changePricePctInput.value = '0'; // 重置未选中的输入框
        } else if (strategyChangePrice.checked) {
            changePricePctInput.disabled = false;
            currPricePctInput.disabled = true;
            currPricePctInput.value = '0'; // 重置未选中的输入框
        }
    }

    // 3. 确认 -> 执行卖出
    function executeSellAll() {
        const selectedCheckboxes = document.querySelectorAll('.sell-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一只股票进行卖出！');
            return;
        }
        const sellStockCodes = [];
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                const stkcode = row.getAttribute('data-stkcode');
                if (stkcode) {
                    sellStockCodes.push(stkcode);
                }
            }
        });
        if (sellStockCodes.length === 0) {
            alert('未能获取到选中股票的代码，请重试！');
            return;
        }

        // --- 读取模态框设置 ---
        const sellPosPctInput = document.getElementById('modalSellPercentageInput');
        let sellPosPct = parseFloat(sellPosPctInput.value);
        if (isNaN(sellPosPct) || sellPosPct < 0 || sellPosPct > 100) {
            alert('请输入有效的 卖出仓位比例 (0-100%)');
            sellPosPctInput.focus();
            return;
        }

        let currPricePct = 0;
        let changePricePct = 0;
        const selectedStrategy = document.querySelector('input[name="modalPriceStrategy"]:checked').value;

        if (selectedStrategy === 'currPricePct') {
            const currPricePctInput = document.getElementById('modalCurrPricePctInput');
            currPricePct = parseFloat(currPricePctInput.value);
            if (isNaN(currPricePct) || currPricePct < -30 || currPricePct > 30) {
                alert('请输入有效的当前价格涨跌幅比例 (-30% 到 30%)');
                currPricePctInput.focus();
                return;
            }
        } else if (selectedStrategy === 'changePricePct') {
            const changePricePctInput = document.getElementById('modalChangePricePctInput');
            changePricePct = parseFloat(changePricePctInput.value);
            if (isNaN(changePricePct) || changePricePct < -30 || changePricePct > 30) {
                alert('请输入有效的昨日收盘价涨跌幅比例 (-30% 到 30%)');
                changePricePctInput.focus();
                return;
            }
        }
        // --- 结束读取模态框设置 ---

        // --- 更新确认消息 ---
        let confirmMsg = `您确定要按【${sellPosPct}%】的 仓位比例，卖出以下【${sellStockCodes.length}】只股票吗？\n`;
        if (selectedStrategy === 'currPricePct' && currPricePct !== 0) {
            confirmMsg += `价格策略: 当前价格【${currPricePct > 0 ? '+' : ''}${currPricePct}%】`;
        } else if (selectedStrategy === 'changePricePct' && changePricePct !== 0) {
            confirmMsg += `价格策略: 昨日收盘价【${changePricePct > 0 ? '+' : ''}${changePricePct}%】`;
        }
        confirmMsg += `\n\n${sellStockCodes.join(', ')}`;

        if (!confirm(confirmMsg)) {
            return;
        }
        // --- 结束更新确认消息 ---

        const sellStockCodeList = sellStockCodes.join(',');
        const originalBtnText = document.getElementById('confirmSellSettingsBtn').textContent;
        document.getElementById('confirmSellSettingsBtn').textContent = '处理中...';
        document.getElementById('confirmSellSettingsBtn').disabled = true;

        // --- 构建API URL，包含新参数 ---
        let apiUrl = `/api/trade/quick/sellPosition?sellStockCodeList=${encodeURIComponent(sellStockCodeList)}&sellPosPct=${sellPosPct}`;
        if (selectedStrategy === 'currPricePct') {
            apiUrl += `&currPricePct=${currPricePct}`;
        } else if (selectedStrategy === 'changePricePct') {
            apiUrl += `&changePricePct=${changePricePct}`;
        }
        // --- 结束构建API URL ---

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('sellSettingsModal'));
        modal.hide();

        ApiUtils.fetch(apiUrl, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (data && data.success) {
                    alert(`【一键等比卖出】操作成功！`);
                    queryPositions();
                } else {
                    const errorMsg = data.msg || '操作失败，未知错误。';
                    alert(`【一键等比卖出】失败：${errorMsg}`);
                    console.error('Sell API Error:', data);
                }
            })
            .catch(error => {
                console.error('【一键等比卖出】请求失败:', error);
                alert(`【一键等比卖出】请求失败：${error.message || error}`);
            })
            .finally(() => {
                document.getElementById('confirmSellSettingsBtn').textContent = originalBtnText;
                document.getElementById('confirmSellSettingsBtn').disabled = false;
            });
    }


    // ----------   一键再融资
    function handleQuickResetFinancing() {
        if (!confirm('您确定要执行【一键再融资】操作吗？\n此操作将【清仓】并【重置融资】，然后【重新融资买入】。')) {
            return;
        }
        const originalBtnText = this.textContent;
        this.textContent = '处理中...';
        this.disabled = true;
        ApiUtils.fetch('/api/trade/quick/resetFinancing', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (data && data.success) {
                    alert(`【一键再融资】操作成功！`);
                    queryPositions(); // 刷新持仓数据
                } else {
                    const errorMsg = data.msg || '操作失败，未知错误。';
                    alert(`【一键再融资】失败：${errorMsg}`);
                    console.error('Quick Reset Financing API Error:', data);
                }
            })
            .catch(error => {
                console.error('【一键再融资】请求失败:', error);
                alert(`【一键再融资】请求失败：${error.message || error}`);
            })
            .finally(() => {
                this.textContent = originalBtnText;
                this.disabled = false;
            });
    }


    // ----------   一键取款

    // 一键取款：主按钮
    function handleQuickLowerFinancing() {
        // 直接从全局变量 netAssetValue 获取数据
        const netAsset = netAssetValue;
        if (isNaN(netAsset) || netAsset <= 0) {
            alert('无法读取净资产，请先查询数据。');
            return;
        }
        // 计算建议金额（净资产的10%）和最大金额
        const suggestedAmount = Math.floor(netAsset * 0.1);
        const maxTransferAmount = Math.floor(netAsset);
        // 设置模态框中的数值
        document.getElementById('currentNetAsset').textContent = netAsset.toLocaleString('en-US');
        document.getElementById('suggestedAmount').textContent = suggestedAmount.toLocaleString('en-US');
        document.getElementById('maxTransferAmount').textContent = maxTransferAmount.toLocaleString('en-US');
        // 自动填充建议金额
        document.getElementById('transferAmountInputModal').value = suggestedAmount;
        // 显示模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickLowerFinancingModal'));
        if (modal) {
            modal.show();
        } else {
            new bootstrap.Modal(document.getElementById('quickLowerFinancingModal')).show();
        }
    }

    // 一键取款：确认
    function confirmQuickLowerFinancing() {
        const transferAmountInput = document.getElementById('transferAmountInputModal');
        let transferAmount = parseFloat(transferAmountInput.value);
        if (isNaN(transferAmount) || transferAmount <= 0) {
            alert('请输入有效的取款金额（大于0）');
            transferAmountInput.focus();
            return;
        }
        // 验证金额是否在合理范围内
        const maxTransferAmountStr = document.getElementById('maxTransferAmount').textContent;
        const maxTransferAmount = parseFloat(maxTransferAmountStr.replace(/,/g, ''));
        if (transferAmount > maxTransferAmount) {
            alert(`取款金额不能超过最大可取金额 (${maxTransferAmount.toLocaleString('en-US')} 元)。`);
            transferAmountInput.focus();
            return;
        }
        if (!confirm(`您确定要执行【一键取款】操作吗？\n取款金额: ${transferAmount.toFixed(2)} 元`)) {
            return;
        }
        const originalBtnText = document.getElementById('confirmQuickLowerFinancingBtn').textContent;
        document.getElementById('confirmQuickLowerFinancingBtn').textContent = '处理中...';
        document.getElementById('confirmQuickLowerFinancingBtn').disabled = true;
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickLowerFinancingModal'));
        modal.hide();
        // 发送请求
        ApiUtils.fetch(`/api/trade/quick/lowerFinancing?transferAmount=${transferAmount}`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            // .then(res => {
            //     return res.ok ? res.json() :
            //         res.json().then(errData => {
            //             throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
            //         });
            // })
            .then(res => res.json())
            .then(data => {
                if (data && data.success) {
                    alert(`【一键取款】操作成功！`);
                    queryPositions(); // 刷新持仓数据
                } else {
                    const errorMsg = data.msg || '操作失败，未知错误。';
                    alert(`【一键取款】失败：${errorMsg}`);
                    console.error('Quick Lower Financing API Error:', data);
                }
            })
            .catch(error => {
                console.error('【一键取款】请求失败：', error);
                alert(`【一键取款】请求失败：${error.message || error}`);
            })
            .finally(() => {
                document.getElementById('confirmQuickLowerFinancingBtn').textContent = originalBtnText;
                document.getElementById('confirmQuickLowerFinancingBtn').disabled = false;
            });
    }


    // ----------------------------------------- 我的持仓 列表 -----------------------------------------------------------


    // 加载
    function loadPositions() {
        ApiUtils.fetch('/api/trade/queryCreditNewPosV2')
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('加载失败：' + data.msg);
                    return;
                }
                const responseData = data.data;
                positionsData = responseData.stocks;
                const setColor = (elementId, value) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.value = value.toLocaleString('en-US', {minimumFractionDigits: 2});
                        el.style.color = value > 0 ? 'red' : value < 0 ? 'teal' : 'black';
                    }
                };
                const setColor_rz = (elementId, value) => {
                    const el2 = document.getElementById(elementId);
                    if (el2) {
                        el2.value = value.toLocaleString('en-US', {minimumFractionDigits: 2});
                        el2.style.color = 'teal';
                    }
                };
                const totalAssetEl = document.getElementById('totalAsset');
                if (totalAssetEl) totalAssetEl.value = responseData.totalasset.toLocaleString('en-US', {minimumFractionDigits: 2});
                const totalMktValEl = document.getElementById('totalMktVal');
                if (totalMktValEl) totalMktValEl.value = responseData.totalmkval.toLocaleString('en-US', {minimumFractionDigits: 2});
                const accessMoneyEl = document.getElementById('accessMoney');
                if (accessMoneyEl) accessMoneyEl.value = responseData.accessmoney.toLocaleString('en-US', {minimumFractionDigits: 2});
                setColor('profit', responseData.profit);
                setColor('curProfit', responseData.curprofit ?? 0);
                const posRatioEl = document.getElementById('posRatio');
                if (posRatioEl) posRatioEl.value = `${(responseData.posratio * 100).toFixed(2)}%`;
                const netAssetEl = document.getElementById('netAsset');
                if (netAssetEl) netAssetEl.value = responseData.netasset.toLocaleString('en-US', {minimumFractionDigits: 2});
                // 更新全局变量，使用原始数值
                netAssetValue = parseFloat(responseData.netasset);
                setColor_rz('totalLiability', responseData.totalliability);
                setColor_rz('marginAvl', responseData.marginavl);
                const marginRatesEl = document.getElementById('marginRates');
                if (marginRatesEl) marginRatesEl.value = `${(responseData.marginrates * 100).toFixed(2)}%`;
                setColor_rz('ftotaldebts', responseData.ftotaldebts);
                setColor('avalmoney', responseData.avalmoney);
                const realrateEl = document.getElementById('realrate');
                if (realrateEl) realrateEl.value = `${(responseData.realrate * 100).toFixed(2)}%`;
                const dtotaldebtsEl = document.getElementById('dtotaldebts');
                if (dtotaldebtsEl) dtotaldebtsEl.value = responseData.dtotaldebts.toLocaleString('en-US', {minimumFractionDigits: 2});
                const acreditavlEl = document.getElementById('acreditavl');
                if (acreditavlEl) acreditavlEl.value = responseData.acreditavl.toLocaleString('en-US', {minimumFractionDigits: 2});
                const holdingStockCountEl = document.getElementById('holdingStockCount');
                if (holdingStockCountEl) holdingStockCountEl.value = (positionsData ? positionsData.length : 0).toLocaleString('en-US');
                displayPositionRecords(positionsData);
                initializePositionsSortIcons();
            })
            .catch(error => {
                console.error('接口请求失败:', error);
                alert('加载数据失败，请检查网络或接口是否正常: ' + error.message);
            });
    }


    // 展示
    function displayPositionRecords(positions) {
        const tbody = document.querySelector('#positionTable tbody');
        if (!tbody) {
            console.error('未找到 #positionTable tbody');
            return;
        }
        tbody.innerHTML = '';
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="20">暂无持仓记录</td></tr>';
            // 更新标题显示数量 0
            document.getElementById('positionsCardTitle').textContent = `持仓详情（0）`;
            return;
        }
        const holdingStockCount = positions.length;
        document.getElementById('holdingStockCount').value = holdingStockCount.toLocaleString('en-US');
        let sortedPositions = [...positions];
        if (sortState.column) {
            sortedPositions = sortedPositions.sort((a, b) => {
                const valA = a[sortState.column] ?? 0;
                const valB = b[sortState.column] ?? 0;
                // 对于 boolean 类型的 topStock 字段，特殊处理
                if (sortState.column === 'topStock') {
                    if (sortState.order === 'asc') {
                        return (a.topStock ? 1 : 0) - (b.topStock ? 1 : 0);
                    } else {
                        return (b.topStock ? 1 : 0) - (a.topStock ? 1 : 0);
                    }
                }
                if (!isNaN(valA) && !isNaN(valB)) {
                    return sortState.order === 'asc' ? valA - valB : valB - valA;
                }
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return sortState.order === 'asc'
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }
                return 0;
            });
        }
        sortedPositions.forEach((item, index) => {
            const marketPrefix = market2Xueqiu(item.market);
            const stockLink = `https://xueqiu.com/S/${marketPrefix}${item.stkcode}`;
            const tr = document.createElement('tr');
            tr.setAttribute('data-stkcode', item.stkcode);

            // --- 处理主线板块列表 ---
            let topBlockListStr = '-';
            if (Array.isArray(item.topBlockList) && item.topBlockList.length > 0) {
                topBlockListStr = item.topBlockList.map(block => `${block.blockName} (${block.topDays}天)`).join('<br>');
            }

            tr.innerHTML = `
              <td><input type="checkbox" class="sell-checkbox"></td>
              <td>${index + 1}</td>
              <td><a href="${stockLink}" target="_blank" class="stock-code-link">${item.stkcode}</a></td>
              <td>${item.stkname}</td>
              <td>${item.market}</td>
              <td>${Number(item.costprice).toFixed(3).replace(/\.?0+$/, '')}</td>
              <td>${Number(item.preClose).toFixed(3).replace(/\.?0+$/, '')}</td>
              <td>${Number(item.lastprice).toFixed(3).replace(/\.?0+$/, '')}</td>
              <td>${item.mktval}</td>
              <td style="color: ${item.profit > 0 ? 'red' : item.profit < 0 ? 'teal' : 'black'}">${item.profit}</td>
              <td style="color: ${item.profitratio > 0 ? 'red' : item.profitratio < 0 ? 'teal' : 'black'}">${(item.profitratio * 100).toFixed(2)}%</td>
              <td style="color: ${item.curprofit > 0 ? 'red' : item.curprofit < 0 ? 'teal' : 'black'}">${item.curprofit?.toFixed(2) ?? '-'}</td>
              <td style="color: ${item.curProfitratio > 0 ? 'red' : item.curProfitratio < 0 ? 'teal' : 'black'}">${item.curProfitratio == null ? '-' : (item.curProfitratio * 100).toFixed(2) + '%'}</td>
              <td>${(item.posratio * 100).toFixed(2)}%</td>
              <td>${item.stkbal}</td>
              <td>${item.stkavl}</td>
              <td>
                ${(() => {
                const hyBlock = item.blockInfoDTO?.hyBlockDTOList || [];
                const normalIndustry = hyBlock.find(b => b.blockType === 2);
                const researchIndustry = hyBlock.find(b => b.blockType === 12);
                const normalName = normalIndustry ? normalIndustry.blockNamePath.split('-')[1] : '';
                const researchName = researchIndustry ? researchIndustry.blockNamePath.split('-')[0] : '';
                const industryStr = [normalName, researchName].filter(Boolean).join(' / ');
                item.industry = industryStr;
                return industryStr;
            })()}
              </td>
              <!-- 主线个股 -->
              <td>${item.topStock ? '<span class="top-stock-indicator">是</span>' : '-'}</td>
              <td>${item.inTopBlock ? '<span class="top-stock-indicator">是</span>' : '-'}</td>
              <!-- 主线板块 -->
              <td class="top-block-list">${topBlockListStr}</td>
              <td>
                <a class="margin-buy-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/MarginBuy?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >融</a>
                <a class="buy-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/Buy?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >担</a>
                <a class="sell-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/Sale?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >卖</a>
              </td>
            `;
            tbody.appendChild(tr);
        });
        // --- 新增：更新持仓列表标题数量 ---
        const count = sortedPositions.length;
        document.getElementById('positionsCardTitle').textContent = `持仓详情（${count}）`;
        // --- 结束：更新持仓列表标题数量 ---
        attachCheckboxListeners();
    }


    // 排序
    function sortPositionsTable(column) {
        if (sortState.column === column) {
            sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.order = 'desc';
            sortState.column = column;
        }
        updatePositionsSortIcon();
        displayPositionRecords(positionsData);
    }

    function updatePositionsSortIcon() {
        const iconIdPrefix = `sort${sortState.column.charAt(0).toUpperCase() + sortState.column.slice(1)}`;
        const iconElement = document.getElementById(iconIdPrefix);
        if (iconElement) {
            iconElement.textContent = sortState.order === 'asc' ? '↑' : '↓';
        }
        // 清除其他列的排序图标
        const allIcons = document.querySelectorAll('#positionTable th span.sort-icon');
        allIcons.forEach(icon => {
            if (icon !== iconElement) {
                icon.textContent = '';
            }
        });
    }

    // 初始化 排序图标
    function initializePositionsSortIcons() {
        if (sortState.column) {
            updatePositionsSortIcon();
        }
    }


    // 折叠/展开
    function toggleCollapse() {
        const content = document.getElementById('collapseContent');
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    }


    // 全选 / 取消全选
    function handleSelectAllChange() {
        // 'this' now refers to the #positionSelectAllCheckboxHeader
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.sell-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

    // 勾选（单个）
    function attachCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.sell-checkbox');
        checkboxes.forEach(checkbox => {
            // Optional: Add individual change listener if needed for other features
        });
        // Modified: Listen to the new header checkbox for positions
        const positionSelectAllCheckboxHeader = document.getElementById('positionSelectAllCheckboxHeader');
        if (positionSelectAllCheckboxHeader) {
            positionSelectAllCheckboxHeader.removeEventListener('change', handleSelectAllChange);
            positionSelectAllCheckboxHeader.addEventListener('change', handleSelectAllChange);
        }
    }


    // ----------------------------------------- 账户设置（融资上限、仓位上限、个股上限）--------------------------------------


    // 加载
    function loadCfgAccount() {
        ApiUtils.fetch('/api/cfg/account/info?id=1') // 假设 ID 为 1
            .then(res => {
                if (!res.ok) {
                    if (res.status === 404) {
                        console.warn('未找到ID为1的持仓账户配置，使用默认值。');
                        // 可以选择初始化默认值或保持表单为空
                        return {success: true, data: null}; // 返回一个模拟的成功响应
                    } else {
                        return res.json().then(errData => {
                            throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                        });
                    }
                }
                return res.json();
            })
            .then(data => {
                if (!data.success) {
                    alert('加载配置失败：' + (data.msg || '未知错误'));
                    return;
                }
                cfgAccountData = data.data || cfgAccountData; // 如果data.data为null，使用默认值
                displayCfgAccountForm(cfgAccountData);
            })
            .catch(error => {
                console.error('查询持仓账户配置失败:', error);
                alert('加载配置失败，请检查网络或接口是否正常: ' + error.message);
            });
    }

    // 展示
    function displayCfgAccountForm(data) {
        if (!data) {
            // 如果数据为空，重置表单为默认值
            document.getElementById('rzAccountCheckbox').checked = false;
            document.getElementById('maxRzPctInput').value = '';
            document.getElementById('posLimitPctInput').value = '';
            document.getElementById('stockPosLimitPctInput').value = '';
            return;
        }
        document.getElementById('rzAccountCheckbox').checked = data.rzAccount === 1;
        document.getElementById('maxRzPctInput').value = data.maxRzPct != null ? data.maxRzPct : '';
        document.getElementById('posLimitPctInput').value = data.posLimitPct != null ? data.posLimitPct : '';
        document.getElementById('stockPosLimitPctInput').value = data.stockPosLimitPct != null ? data.stockPosLimitPct : '';
        // 存储ID以便后续更新
        cfgAccountData.id = data.id;
    }

    // 保存
    function saveCfgAccount() {
        const formData = {
            id: cfgAccountData.id, // 包含ID，如果为null则为新增
            rzAccount: document.getElementById('rzAccountCheckbox').checked ? 1 : 0,
            maxRzPct: parseFloat(document.getElementById('maxRzPctInput').value) || 0,
            posLimitPct: parseFloat(document.getElementById('posLimitPctInput').value) || 0,
            stockPosLimitPct: parseFloat(document.getElementById('stockPosLimitPctInput').value) || 0
            // gmtCreate 和 gmtModify 通常由后端处理，前端不需要发送
        };

        const url = '/api/cfg/account/update';
        const method = 'POST';

        const saveBtn = document.getElementById('saveCfgAccountBtn');
        const originalBtnText = saveBtn.textContent;
        saveBtn.textContent = '保存中...';
        saveBtn.disabled = true;

        ApiUtils.fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (data && data.success) {
                    alert('配置保存成功！');
                    // 保存成功后，重新查询以获取最新的gmtModify时间等
                    loadCfgAccount();
                } else {
                    const errorMsg = data.msg || '操作失败，未知错误。';
                    alert(`配置保存失败：${errorMsg}`);
                    console.error('Save CfgAccount API Error:', data);
                }
            })
            .catch(error => {
                console.error('保存持仓账户配置失败:', error);
                alert(`保存配置失败：${error.message || error}`);
            })
            .finally(() => {
                saveBtn.textContent = originalBtnText;
                saveBtn.disabled = false;
            });
    }

    // 折叠/展开
    function toggleCfgAccountCollapse() {
        const content = document.getElementById('cfgAccountCollapseContent');
        const saveButton = document.getElementById('saveCfgAccountBtn'); // 获取保存按钮
        const header = document.getElementById('cfgAccountCardHeader');
        const btnText = document.getElementById('cfgAccountCollapseBtn');

        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            // 可选：更新按钮文字或图标
            // btnText.textContent = '折叠';

            // 显示保存按钮
            if (saveButton) {
                saveButton.style.display = 'block'; // 或者使用 'inline-block' 以匹配其原始显示方式
            }
        } else {
            content.style.display = 'none';
            // 可选：更新按钮文字或图标
            // btnText.textContent = '展开';

            // 隐藏保存按钮
            if (saveButton) {
                saveButton.style.display = 'none';
            }
        }
    }


    // ----------------------------------------- 当日委托 列表 -----------------------------------------------------------


    // 加载
    function loadOrders() {
        const refreshBtn = document.getElementById('refreshOrdersButton');
        const originalText = refreshBtn.textContent;
        refreshBtn.textContent = '加载中...';
        refreshBtn.disabled = true;


        // --- 新增：获取日期范围 ---
        // 或者，你想默认加载今天的数据，可以设置默认值。
        const ordersStartDateInput = document.getElementById('ordersStartDateInput');
        const ordersEndDateInput = document.getElementById('ordersEndDateInput');

        if (ordersStartDateInput) {
            ordersStartDateInput.max = today;
        }
        if (ordersEndDateInput) {
            ordersEndDateInput.max = today;
        }


        let ordersStartDate = ordersStartDateInput.value ? ordersStartDateInput.value : today; // 获取开始日期
        let ordersEndDate = ordersEndDateInput.value ? ordersEndDateInput.value : today;       // 获取结束日期


        // 验证日期（简单验证）
        if (ordersStartDate && ordersEndDate && ordersStartDate > ordersEndDate) {
            alert('开始日期不能晚于结束日期！');
            refreshBtn.textContent = originalText;
            refreshBtn.disabled = false;
            return;
        }

        // 修正：验证日期范围不能超过1年 (365天)
        if (ordersStartDate && ordersEndDate) {
            const startDateObj = new Date(ordersStartDate);
            const endDateObj = new Date(ordersEndDate);
            // 计算时间差（毫秒）
            const timeDifference = endDateObj.getTime() - startDateObj.getTime();
            // 转换为天数
            const dayDifference = timeDifference / (1000 * 3600 * 24);

            if (dayDifference > 365) {
                alert('查询范围不能超过1年！');
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
                return;
            }
        }

        // // 如果没有提供日期，则默认查询今天的数据
        // if (!ordersStartDate || !ordersEndDate) {
        //     // const today = today; // 格式化为 YYYY-MM-DD
        //     ordersStartDate = today;
        //     ordersEndDate = today;
        //     console.warn("未指定日期范围，默认查询今日数据。");
        //
        //     // 如果你想强制用户选择日期，可以取消注释下面的代码
        //     // alert("请先选择开始日期和结束日期。");
        //     // refreshBtn.textContent = originalText;
        //     // refreshBtn.disabled = false;
        //     // return;
        // }


        // ApiUtils.fetch('/api/trade/getOrdersData')
        ApiUtils.fetch(`/api/trade/queryCreditHisOrderV2?startDate=${ordersStartDate}&endDate=${ordersEndDate}`)
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取委托数据失败');
                }
                ordersData = data.data || []; // 更新全局数据
                displayOrders(ordersData);
                updateOrdersSortIcon();
            })
            .catch(error => {
                console.error('获取当日委托失败:', error);
                const tbody = document.querySelector('#ordersTable tbody');
                const messageDiv = document.getElementById('ordersTableMessage');
                if (tbody && messageDiv) {
                    tbody.innerHTML = '';
                    messageDiv.style.display = 'block';
                    messageDiv.textContent = `加载失败：${error.message}`;
                    // 确保在错误时也更新标题数量
                    document.getElementById('ordersCardTitle').textContent = `当日委托列表（0）`;
                }
            })
            .finally(() => {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            });
    }


    // 展示
    function displayOrders(orders) {
        const tbody = document.querySelector('#ordersTable tbody');
        const messageDiv = document.getElementById('ordersTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #ordersTable tbody 或 #ordersTableMessage');
            return;
        }
        const statusFilter = document.getElementById('filterStatus').value;
        const directionFilter = document.getElementById('filterDirection').value;
        let filteredOrders = orders;
        if (statusFilter) {
            // 未成交 -> 未报/已报/部成
            if (statusFilter === '未成交') {
                filteredOrders = filteredOrders.filter(order => order.wtzt === '未报' || order.wtzt === '已报' || order.wtzt === '部成');
            }
            // 已成交 -> 已撤/已成/废单
            else if (statusFilter === '已成交') {
                filteredOrders = filteredOrders.filter(order => order.wtzt === '已撤' || order.wtzt === '已成' || order.wtzt === '废单');
            } else {
                filteredOrders = filteredOrders.filter(order => order.wtzt === statusFilter);
            }
        }
        if (directionFilter) {
            filteredOrders = filteredOrders.filter(order => order.mmsm === directionFilter);
        }
        let sortedOrders = [...filteredOrders];
        if (ordersSortState.column) {
            sortedOrders.sort((a, b) => {
                let valA = a[ordersSortState.column];
                let valB = b[ordersSortState.column];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return ordersSortState.order === 'asc' ? numA - numB : numB - numA;
                }
                const comparison = String(valA).localeCompare(String(valB));
                return ordersSortState.order === 'asc' ? comparison : -comparison;
            });
        }
        tbody.innerHTML = '';
        if (sortedOrders.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无匹配的委托记录';
            // 更新标题显示数量 0
            document.getElementById('ordersCardTitle').textContent = `当日委托列表（0）`;
        } else {
            messageDiv.style.display = 'none';
            sortedOrders.forEach((order, index) => {
                const marketPrefix = market2Xueqiu(order.market);
                const stockLink = `https://xueqiu.com/S/${marketPrefix}${order.zqdm}`;
                const tr = document.createElement('tr');
                let formattedTime = order.wtsj;
                if (order.wtsj && order.wtsj.length === 6) {
                    formattedTime = `${order.wtsj.substring(0, 2)}:${order.wtsj.substring(2, 4)}:${order.wtsj.substring(4, 6)}`;
                }
                // 确定是否显示撤单按钮 (状态为 未报/已报/部成)
                const isCancelable = (order.wtzt === '未报' || order.wtzt === '已报' || order.wtzt === '部成');
                // 确定是否允许批量勾选 (状态为 未报/已报/部成)
                const isBatchCancelable = isCancelable;
                tr.innerHTML = `
                    <td>${isBatchCancelable ? `<input type="checkbox" class="order-checkbox" data-wtdh="${order.wtbh}" data-date="${order.wtrq}">` : ''}</td>
                    <td>${order.wtbh}</td>
                    <td>${order.wtrq}</td>
                    <td>${formattedTime}</td>
                    <td><a href="${stockLink}" target="_blank" class="stock-code-link">${order.zqdm}</a></td>
                    <td>${order.zqmc}</td>
                    <td>${order.mmsm}</td>
                    <td class="order-status-${order.wtzt}">${order.wtzt}</td>
                    <td>${Number(order.wtjg)}</td>
                    <td>${order.wtsl}</td>
                    <td>${Number(order.wtje)}</td>
                    <td>${Number(order.posPct)}</td>
                    <td>${Number(order.cjjg)}</td>
                    <td>${order.cjsl}</td>
                    <td>${Number(order.cjje)}</td>
                    <td>
                        ${isCancelable ? `<button class="cancel-order-button" data-wtbh="${order.wtbh}" data-date="${order.wtrq}">撤单</button>` : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 更新当日委托列表 标题数量
            const count = sortedOrders.length; // 使用过滤和排序后的数量
            document.getElementById('ordersCardTitle').textContent = `当日委托列表（${count}）`;
        }

        // 更新全选状态
        updateOrdersSelectAllState();
    }


    // 排序
    function sortOrdersTable(column) {
        if (ordersSortState.column === column) {
            ordersSortState.order = ordersSortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            ordersSortState.order = 'asc';
            ordersSortState.column = column;
        }
        updateOrdersSortIcon();
        displayOrders(ordersData);
    }

    function updateOrdersSortIcon() {
        const iconIdPrefix = `sort${ordersSortState.column ? ordersSortState.column.charAt(0).toUpperCase() + ordersSortState.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);
        const allIcons = document.querySelectorAll('#ordersTable th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });
        if (iconElement && ordersSortState.column) {
            iconElement.textContent = ordersSortState.order === 'asc' ? '↑' : '↓';
        }
    }


    // 撤单（单个）
    function cancelOrder(date, wtbh, buttonElement) {
        // Basic validation
        if (!date || !wtbh) {
            console.error('撤销委托失败：缺少必要的委托日期或编号', {date, wtbh});
            alert('撤销委托失败：缺少必要的委托日期或编号！');
            return;
        }
        if (!confirm(`确定要撤销委托编号【${wtbh}】吗？`)) {
            return;
        }
        buttonElement.textContent = '撤销中...';
        buttonElement.disabled = true;

        const cancelParamsList = [{date: date, wtdh: wtbh}];
        ApiUtils.fetch('/api/trade/revokeOrders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cancelParamsList) // Send the array in the request body
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `撤销失败 HTTP ${res.status}`);
                    });
            })
            .then(data => {
                // data = { success: true, msg: "...", data: [ { revoke: "...", resultDesc: "...", suc: true/false }, ... ] }
                if (data && data.success === true) {
                    const results = data.data || [];
                    if (results.length > 0) {
                        // 操作结果（单个委托单）
                        const result = results[0];
                        if (result.suc === true) {
                            alert(`委托【${wtbh}】撤销成功！\n${result.resultDesc || ''}`);
                            loadOrders();
                            loadPositions();
                        } else {
                            // 操作失败
                            throw new Error(result.resultDesc || `撤销操作未成功 (委托: ${wtbh})`);
                        }
                    } else {
                        // Unexpected: success=true but no data returned for the order
                        console.warn('撤销接口返回成功，但未包含订单结果。', data);
                        alert(`委托 ${wtbh} 撤销请求已提交，但未收到明确成功确认。`);
                        loadOrders();
                        loadPositions();
                    }
                } else {
                    // 异常
                    throw new Error(data.msg || '撤销操作未成功');
                }
            })
            .catch(error => {
                console.error('撤销委托失败:', error);
                // 异常 弹框提示
                alert(`撤销委托【${wtbh}】失败：${error.message}`);
                // Optional: Re-enable the button on error if you want user to retry
                // buttonElement.textContent = originalText;
                // buttonElement.disabled = false;
            })
            .finally(() => {
                // Note: The button state is not restored here because loadOrders() will re-render the table.
                // If loadOrders fails or you decide not to reload, you might want to restore the button here.
            });
    }

    // 批量撤单 (根据新返回结果调整)
    function handleBatchCancelOrders() {
        const selectedCheckboxes = document.querySelectorAll('#ordersTable .order-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一条委托记录进行撤单！');
            return;
        }
        const cancelParamsList = [];
        selectedCheckboxes.forEach(checkbox => {
            const wtdh = checkbox.getAttribute('data-wtdh');
            const date = checkbox.getAttribute('data-date');
            if (wtdh && date) {
                // 注意：发送给后端的字段名是 wtdh 和 date，与 TradeRevokeOrdersParam DTO 对应
                cancelParamsList.push({wtdh: wtdh, date: date});
            }
        });
        if (cancelParamsList.length === 0) {
            alert('未能获取到选中委托的编号或日期，请重试！');
            return;
        }
        const confirmMsg = `您确定要撤销以下【${cancelParamsList.length}】条委托吗？\n${cancelParamsList.map(p => p.wtdh).join(', ')}`;
        if (!confirm(confirmMsg)) {
            return;
        }
        const batchCancelBtn = document.getElementById('batchCancelOrdersButton');
        const originalBtnText = batchCancelBtn.textContent;
        batchCancelBtn.textContent = '处理中...';
        batchCancelBtn.disabled = true;
        ApiUtils.fetch('/api/trade/revokeOrders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(cancelParamsList) // 发送参数对象的数组
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (data && data.success) {
                    // 处理新的返回结构
                    const results = data.data || []; // data.data 是 RevokeOrderResultDTO 的数组
                    let successCount = 0;
                    let failCount = 0;
                    let messages = [];
                    results.forEach(res => {
                        // {
                        //    "revoke": "20250919_10123",
                        //    "resultDesc": "20250919: 您的撤单委托已提交，可至当日委托查看撤单结果",
                        //    "suc": true
                        // }
                        // 根据新的返回结构处理
                        if (res.suc) { // 检查 suc 字段
                            successCount++;
                        } else {
                            failCount++;
                            // 使用 resultDesc 字段作为失败信息
                            messages.push(`委托 ${res.revoke.split('_')[1]}: ${res.resultDesc || '未知错误'}`); // 提取 wtdh 用于显示
                        }
                    });
                    let finalMsg = `批量撤单完成！成功: ${successCount}, 失败：${failCount}`;
                    if (messages.length > 0) {
                        finalMsg += `\n失败详情:\n${messages.join('\n')}`;
                    }
                    alert(finalMsg);
                    loadOrders(); // 刷新列表
                    loadPositions();
                } else {
                    const errorMsg = data.msg || '批量撤单失败，未知错误。';
                    alert(`批量撤单失败：${errorMsg}`);
                    console.error('Batch Cancel API Error:', data);
                }
            })
            .catch(error => {
                console.error('批量撤单请求失败:', error);
                alert(`批量撤单请求失败：${error.message || error}`);
            })
            .finally(() => {
                batchCancelBtn.textContent = originalBtnText;
                batchCancelBtn.disabled = false;
            });
    }

    // 一键撤单
    function handleQuickCancelOrder() {
        if (!confirm('您确定要 撤销所有【未报/已报/部成】状态的委托吗？')) {
            return;
        }
        const quickCancelBtn = document.getElementById('quickCancelOrdersButton');
        const originalBtnText = quickCancelBtn.textContent;
        quickCancelBtn.textContent = '处理中...';
        quickCancelBtn.disabled = true;
        ApiUtils.fetch('/api/trade/quick/cancelOrder', {
            method: 'GET', // 根据你的 Controller 定义
            headers: {'Content-Type': 'application/json'}
        })
            .then(res => {
                return res.ok ? res.json() :
                    res.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
                    });
            })
            .then(data => {
                if (data && data.success) {
                    alert(`【一键撤单】操作成功！`);
                    loadOrders(); // 刷新列表
                    loadPositions();
                } else {
                    const errorMsg = data.msg || '【一键撤单】失败，未知错误。';
                    alert(`【一键撤单】失败：${errorMsg}`);
                    console.error('Quick Cancel API Error:', data);
                }
            })
            .catch(error => {
                console.error('【一键撤单】请求失败:', error);
                alert(`【一键撤单】请求失败：${error.message || error}`);
            })
            .finally(() => {
                quickCancelBtn.textContent = originalBtnText;
                quickCancelBtn.disabled = false;
            });
    }

    // 全选 / 取消全选
    function handleOrdersSelectAllChange() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('#ordersTable .order-checkbox');
        checkboxes.forEach(checkbox => {
            // 只勾选那些可以被批量撤销的（即有 checkbox 的行）
            if (checkbox.closest('tr').querySelector('input[type="checkbox"]')) {
                checkbox.checked = isChecked;
            }
        });
    }

    // 更新 全选按钮 状态
    function updateOrdersSelectAllState() {
        const allCheckboxes = document.querySelectorAll('#ordersTable .order-checkbox');
        // Modified: Use the new header checkbox for orders
        const selectAllCheckbox = document.getElementById('ordersSelectAllCheckboxHeader');
        if (allCheckboxes.length === 0) {
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            return;
        }
        const checkedCheckboxes = document.querySelectorAll('#ordersTable .order-checkbox:checked');
        if (selectAllCheckbox) {
            if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true; // 半选状态
            }
        }
    }


    // ----------------------------------------- 主线板块 列表（机选）-----------------------------------------------------


    // 加载
    function loadTopBlocks(date = topBlocksCurrentDate) {
        const tbody = document.querySelector('#topBlocksTable tbody');
        const messageDiv = document.getElementById('topBlocksTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topBlocksTable tbody 或 #topBlocksTableMessage');
            return;
        }

        // 清空内容
        tbody.innerHTML = '';
        messageDiv.style.display = 'none';

        ApiUtils.fetch(`/api/topBlock/bk-yd2/topBlockList?date=${date}&type=1`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取主线板块列表失败');
                }

                topBlockAvgPctData = data.data.topBlockAvgPctDTO || {};

                // 处理数据，将 changePctDTO 的字段平铺到主对象
                topBlocksData = (data.data.topBlockDTOList || []).map((block, index) => {
                    const changePctDTO = block.changePctDTO || {};
                    return {
                        rank: index + 1, // 添加序号
                        blockCode: block.blockCode,
                        blockName: block.blockName,
                        topDays: block.topDays,
                        topStockSize: block.topStockSize,
                        topStockList: Array.isArray(block.topStockList) && block.topStockList.length > 0
                            // ? block.topStockList.map(s => `${s.stockName} (${s.topDays}天)`).join(', ')
                            ? block.topStockList.map(s => stockLink(s.xueqiuMarket, s.stockCode, s.stockName, s.topDays)).join(', ')
                            : '-',
                        topStartDate: changePctDTO.topStartDate || '-',
                        topEndDate: changePctDTO.topEndDate || '-',
                        start2Today_changePct: changePctDTO.start2Today_changePct || 0,
                        start2End_changePct: changePctDTO.start2End_changePct || 0,
                        start2Max_changePct: changePctDTO.start2Max_changePct || 0,
                        today2Next_changePct: changePctDTO.today2Next_changePct || 0,
                        today2End_changePct: changePctDTO.today2End_changePct || 0,
                        today2Max_changePct: changePctDTO.today2Max_changePct || 0,
                        start2Next_changePct: changePctDTO.start2Next_changePct || 0,
                        start2Next3_changePct: changePctDTO.start2Next3_changePct || 0,
                        start2Next5_changePct: changePctDTO.start2Next5_changePct || 0,
                        start2Next10_changePct: changePctDTO.start2Next10_changePct || 0,
                        start2Next15_changePct: changePctDTO.start2Next15_changePct || 0,
                        start2Next20_changePct: changePctDTO.start2Next20_changePct || 0,
                    };
                });

                if (!topBlocksData || topBlocksData.length === 0) {

                    messageDiv.style.display = 'block';
                    messageDiv.textContent = '暂无数据';
                    document.getElementById('topBlocksCardTitle').textContent = `主线板块列表（${date}）（0）`;

                    // 移除平均值行
                    const thead = document.querySelector('#topBlocksTable thead');
                    if (thead) {
                        const existingAvgRow = thead.querySelector('tr.avg-row');
                        if (existingAvgRow) {
                            existingAvgRow.remove();
                        }
                    }

                    return;
                }

                // 渲染平均值行
                displayTopBlocksAvgRow(topBlockAvgPctData);
                // 根据当前排序状态显示数据
                displayTopBlocks(topBlocksData);
            })
            .catch(error => {
                console.error('获取主线板块列表失败:', error);
                // 注意：colspan 改为 11
                tbody.innerHTML = '<tr><td colspan="11">加载失败：' + error.message + '</td></tr>';
                document.getElementById('topBlocksCardTitle').textContent = `主线板块列表（${date}）（0）`;
            });
    }

    function stockLink(xueqiuMarket, stockCode, stockName, topDays) {
        const stockLink = `https://xueqiu.com/S/${xueqiuMarket}${stockCode}`;
        return `<a href="${stockLink}" target="_blank" class="stock-code-link">${stockName} (${topDays}天)</a>`;
    }


    // 展示
    function displayTopBlocks(blocks) {
        const tbody = document.querySelector('#topBlocksTable tbody');
        const messageDiv = document.getElementById('topBlocksTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topBlocksTable tbody 或 #topBlocksTableMessage');
            return;
        }

        let sortedBlocks = [...blocks];
        if (topBlocksSortState.column) {
            sortedBlocks.sort((a, b) => {
                let valA = a[topBlocksSortState.column];
                let valB = b[topBlocksSortState.column];
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                // number
                if (typeof valA === 'number') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return topBlocksSortState.order === 'asc' ? numA - numB : numB - numA;
                    }
                }

                // string
                const comparison = String(valA).localeCompare(String(valB));
                return topBlocksSortState.order === 'asc' ? comparison : -comparison;
            });
        }

        tbody.innerHTML = '';
        if (sortedBlocks.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无数据';
            document.getElementById('topBlocksCardTitle').textContent = `主线板块列表（${topBlocksCurrentDate}）（0）`;
        } else {
            messageDiv.style.display = 'none';
            sortedBlocks.forEach((block) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${block.rank}</td>
                    <td>${block.blockCode}</td>
                    <td>${block.blockName}</td>
                    <td>${block.topDays}</td>
                    <td>${block.topStockSize}</td>
                    <td class="top-list-item">${block.topStockList}</td>
                    <td>${block.topStartDate}</td>
                    <td>${block.topEndDate}</td>
                    <td style="color: ${block.start2Today_changePct > 0 ? 'red' : block.start2Today_changePct < 0 ? 'teal' : 'black'}">${block.start2Today_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2End_changePct > 0 ? 'red' : block.start2End_changePct < 0 ? 'teal' : 'black'}">${block.start2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Max_changePct > 0 ? 'red' : block.start2Max_changePct < 0 ? 'teal' : 'black'}">${block.start2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2Next_changePct > 0 ? 'red' : block.today2Next_changePct < 0 ? 'teal' : 'black'}">${block.today2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2End_changePct > 0 ? 'red' : block.today2End_changePct < 0 ? 'teal' : 'black'}">${block.today2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2Max_changePct > 0 ? 'red' : block.today2Max_changePct < 0 ? 'teal' : 'black'}">${block.today2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next_changePct > 0 ? 'red' : block.start2Next_changePct < 0 ? 'teal' : 'black'}">${block.start2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next3_changePct > 0 ? 'red' : block.start2Next3_changePct < 0 ? 'teal' : 'black'}">${block.start2Next3_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next5_changePct > 0 ? 'red' : block.start2Next5_changePct < 0 ? 'teal' : 'black'}">${block.start2Next5_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next10_changePct > 0 ? 'red' : block.start2Next10_changePct < 0 ? 'teal' : 'black'}">${block.start2Next10_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next15_changePct > 0 ? 'red' : block.start2Next15_changePct < 0 ? 'teal' : 'black'}">${block.start2Next15_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next20_changePct > 0 ? 'red' : block.start2Next20_changePct < 0 ? 'teal' : 'black'}">${block.start2Next20_changePct.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('topBlocksCardTitle').textContent = `主线板块列表（${topBlockAvgPctData.date}）（${sortedBlocks.length}）`;
        }
    }

    function displayTopBlocksAvgRow(avgPct) {
        const thead = document.querySelector('#topBlocksTable thead');
        if (!thead) {
            console.error('未找到 #topBlocksTable thead');
            return;
        }

        // 清除可能已存在的平均值行
        const existingAvgRow = document.querySelector('#topBlocksTable thead tr.avg-row');
        if (existingAvgRow) {
            existingAvgRow.remove();
        }

        const avgRow = document.createElement('tr');
        avgRow.className = 'avg-row'; // 添加类名以便样式控制

        // 前8列是基本信息，需要合并显示标签
        avgRow.innerHTML = `
            <td colspan="8" class="text-center avg-label">【指数】平均值</td>
            <td style="color: ${avgPct.start2Today_changePct > 0 ? 'red' : avgPct.start2Today_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Today_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2End_changePct > 0 ? 'red' : avgPct.start2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Max_changePct > 0 ? 'red' : avgPct.start2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Next_changePct > 0 ? 'red' : avgPct.today2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2End_changePct > 0 ? 'red' : avgPct.today2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Max_changePct > 0 ? 'red' : avgPct.today2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next_changePct > 0 ? 'red' : avgPct.start2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next3_changePct > 0 ? 'red' : avgPct.start2Next3_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next3_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next5_changePct > 0 ? 'red' : avgPct.start2Next5_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next5_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next10_changePct > 0 ? 'red' : avgPct.start2Next10_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next10_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next15_changePct > 0 ? 'red' : avgPct.start2Next15_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next15_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next20_changePct > 0 ? 'red' : avgPct.start2Next20_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next20_changePct.toFixed(2)}%
            </td>
        `;

        // 将平均值行插入到原始表头行之后
        thead.appendChild(avgRow);
    }


    // 排序
    function updateTopBlocksSortIcon() {
        const iconIdPrefix = `sortTopBlocks${topBlocksSortState.column ? topBlocksSortState.column.charAt(0).toUpperCase() + topBlocksSortState.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);
        const allIcons = document.querySelectorAll('#topBlocksTable th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });
        if (iconElement && topBlocksSortState.column) {
            iconElement.textContent = topBlocksSortState.order === 'asc' ? '↑' : '↓';
        }
    }

    function sortTopBlocksTable(column) {
        if (topBlocksSortState.column === column) {
            topBlocksSortState.order = topBlocksSortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            topBlocksSortState.order = 'desc'; // 默认倒序
            topBlocksSortState.column = column;
        }
        updateTopBlocksSortIcon();
        displayTopBlocks(topBlocksData);
    }


    // ----------------------------------------- 主线个股 列表（机选）-----------------------------------------------------

    // 加载
    function loadTopStocks(date = topStocksCurrentDate) {
        const tbody = document.querySelector('#topStocksTable tbody');
        const messageDiv = document.getElementById('topStocksTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topStocksTable tbody 或 #topStocksTableMessage');
            return;
        }

        // 清空内容
        tbody.innerHTML = '';
        messageDiv.style.display = 'none';

        ApiUtils.fetch(`/api/topBlock/bk-yd2/topStockList?date=${date}&type=1`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取主线个股列表失败');
                }

                topStockAvgPctData = data.data.topStockAvgPctDTO || {};

                // 处理数据，将 changePctDTO 的字段平铺到主对象
                topStocksData = (data.data.topStockDTOList || []).map((stock, index) => {
                    const changePctDTO = stock.changePctDTO || {};
                    return {
                        rank: index + 1, // 添加序号
                        stockCode: stock.stockCode,
                        stockName: stock.stockName,
                        xueqiuMarket: stock.xueqiuMarket,
                        topDays: stock.topDays,
                        topBlockSize: stock.topBlockSize,
                        topBlockList: Array.isArray(stock.topBlockList) && stock.topBlockList.length > 0
                            ? stock.topBlockList.map(b => `${b.blockName} (${b.topDays}天)`).join(', ')
                            : '-',
                        topStartDate: changePctDTO.topStartDate || '-',
                        topEndDate: changePctDTO.topEndDate || '-',
                        start2Today_changePct: changePctDTO.start2Today_changePct || 0,
                        start2End_changePct: changePctDTO.start2End_changePct || 0,
                        start2Max_changePct: changePctDTO.start2Max_changePct || 0,
                        today2Next_changePct: changePctDTO.today2Next_changePct || 0,
                        today2End_changePct: changePctDTO.today2End_changePct || 0,
                        today2Max_changePct: changePctDTO.today2Max_changePct || 0,
                        start2Next_changePct: changePctDTO.start2Next_changePct || 0,
                        start2Next3_changePct: changePctDTO.start2Next3_changePct || 0,
                        start2Next5_changePct: changePctDTO.start2Next5_changePct || 0,
                        start2Next10_changePct: changePctDTO.start2Next10_changePct || 0,
                        start2Next15_changePct: changePctDTO.start2Next15_changePct || 0,
                        start2Next20_changePct: changePctDTO.start2Next20_changePct || 0,
                    };
                });

                if (!topStocksData || topStocksData.length === 0) {

                    messageDiv.style.display = 'block';
                    messageDiv.textContent = '暂无数据';
                    document.getElementById('topStocksCardTitle').textContent = `主线个股列表（${date}）（0）`;

                    // 移除平均值行
                    const thead = document.querySelector('#topStocksTable thead');
                    if (thead) {
                        const existingAvgRow = thead.querySelector('tr.avg-row');
                        if (existingAvgRow) {
                            existingAvgRow.remove();
                        }
                    }

                    return;
                }


                // 渲染平均值行
                displayTopStocksAvgRow(topStockAvgPctData);
                // 根据当前排序状态显示数据
                displayTopStocks(topStocksData);
            })
            .catch(error => {
                console.error('获取主线个股列表失败:', error);
                // 注意：colspan 改为 11
                tbody.innerHTML = '<tr><td colspan="11">加载失败：' + error.message + '</td></tr>';
                document.getElementById('topStocksCardTitle').textContent = `主线个股列表（${date}）（0）`;
            });
    }


    // 展示
    function displayTopStocks(stocks) {
        const tbody = document.querySelector('#topStocksTable tbody');
        const messageDiv = document.getElementById('topStocksTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topStocksTable tbody 或 #topStocksTableMessage');
            return;
        }

        let sortedStocks = [...stocks];
        if (topStocksSortState.column) {
            sortedStocks.sort((a, b) => {
                let valA = a[topStocksSortState.column];
                let valB = b[topStocksSortState.column];
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                // number
                if (typeof valA === 'number') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return topStocksSortState.order === 'asc' ? numA - numB : numB - numA;
                    }
                }

                // string
                const comparison = String(valA).localeCompare(String(valB));
                return topStocksSortState.order === 'asc' ? comparison : -comparison;
            });
        }

        tbody.innerHTML = '';
        if (sortedStocks.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无数据';
            document.getElementById('topStocksCardTitle').textContent = `主线个股列表（${topStocksCurrentDate}）（0）`;
        } else {
            messageDiv.style.display = 'none';
            sortedStocks.forEach((stock) => {
                const stockLink = `https://xueqiu.com/S/${stock.xueqiuMarket}${stock.stockCode}`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${stock.rank}</td>
                    <td><a href="${stockLink}" target="_blank" class="stock-code-link">${stock.stockCode}</a></td>
                    <td>${stock.stockName}</td>
                    <td>${stock.topDays}</td>
                    <td>${stock.topBlockSize}</td>
                    <td class="top-list-item">${stock.topBlockList}</td>
                    <td>${stock.topStartDate}</td>
                    <td>${stock.topEndDate.toString()}</td>
                    <td style="color: ${stock.start2Today_changePct > 0 ? 'red' : stock.start2Today_changePct < 0 ? 'teal' : 'black'}">${stock.start2Today_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2End_changePct > 0 ? 'red' : stock.start2End_changePct < 0 ? 'teal' : 'black'}">${stock.start2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Max_changePct > 0 ? 'red' : stock.start2Max_changePct < 0 ? 'teal' : 'black'}">${stock.start2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2Next_changePct > 0 ? 'red' : stock.today2Next_changePct < 0 ? 'teal' : 'black'}">${stock.today2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2End_changePct > 0 ? 'red' : stock.today2End_changePct < 0 ? 'teal' : 'black'}">${stock.today2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2Max_changePct > 0 ? 'red' : stock.today2Max_changePct < 0 ? 'teal' : 'black'}">${stock.today2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next_changePct > 0 ? 'red' : stock.start2Next_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next3_changePct > 0 ? 'red' : stock.start2Next3_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next3_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next5_changePct > 0 ? 'red' : stock.start2Next5_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next5_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next10_changePct > 0 ? 'red' : stock.start2Next10_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next10_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next15_changePct > 0 ? 'red' : stock.start2Next15_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next15_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next20_changePct > 0 ? 'red' : stock.start2Next20_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next20_changePct.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('topStocksCardTitle').textContent = `主线个股列表（${topStockAvgPctData.date}）（${sortedStocks.length}）`;
        }
    }

    function displayTopStocksAvgRow(avgPct) {
        const thead = document.querySelector('#topStocksTable thead');
        if (!thead) {
            console.error('未找到 #topStocksTable thead');
            return;
        }

        // 清除可能已存在的平均值行
        const existingAvgRow = document.querySelector('#topStocksTable thead tr.avg-row');
        if (existingAvgRow) {
            existingAvgRow.remove();
        }

        const avgRow = document.createElement('tr');
        avgRow.className = 'avg-row'; // 添加类名以便样式控制

        // 前8列是基本信息，需要合并显示标签
        avgRow.innerHTML = `
            <td colspan="8" class="text-center avg-label">【指数】平均值</td>
            <td style="color: ${avgPct.start2Today_changePct > 0 ? 'red' : avgPct.start2Today_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Today_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2End_changePct > 0 ? 'red' : avgPct.start2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Max_changePct > 0 ? 'red' : avgPct.start2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Next_changePct > 0 ? 'red' : avgPct.today2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2End_changePct > 0 ? 'red' : avgPct.today2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Max_changePct > 0 ? 'red' : avgPct.today2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next_changePct > 0 ? 'red' : avgPct.start2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next3_changePct > 0 ? 'red' : avgPct.start2Next3_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next3_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next5_changePct > 0 ? 'red' : avgPct.start2Next5_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next5_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next10_changePct > 0 ? 'red' : avgPct.start2Next10_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next10_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next15_changePct > 0 ? 'red' : avgPct.start2Next15_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next15_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next20_changePct > 0 ? 'red' : avgPct.start2Next20_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next20_changePct.toFixed(2)}%
            </td>
        `;

        // 将平均值行插入到原始表头行之后
        thead.appendChild(avgRow);
    }


    // 排序
    function updateTopStocksSortIcon() {
        const iconIdPrefix = `sortTopStocks${topStocksSortState.column ? topStocksSortState.column.charAt(0).toUpperCase() + topStocksSortState.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);
        const allIcons = document.querySelectorAll('#topStocksTable th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });
        if (iconElement && topStocksSortState.column) {
            iconElement.textContent = topStocksSortState.order === 'asc' ? '↑' : '↓';
        }
    }

    function sortTopStocksTable(column) {
        if (topStocksSortState.column === column) {
            topStocksSortState.order = topStocksSortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            topStocksSortState.order = 'desc'; // 默认倒序
            topStocksSortState.column = column;
        }
        updateTopStocksSortIcon();
        displayTopStocks(topStocksData);
    }


    // ----------------------------------------- 主线板块 列表（人选）-----------------------------------------------------


    // 加载
    function loadTopBlocksManual(date = topBlocksCurrentDateManual) {
        const tbody = document.querySelector('#topBlocksTableManual tbody');
        const messageDiv = document.getElementById('topBlocksTableManualMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topBlocksTableManual tbody 或 #topBlocksTableManualMessage');
            return;
        }
        // 清空内容
        tbody.innerHTML = '';
        messageDiv.style.display = 'none';
        ApiUtils.fetch(`/api/topBlock/bk-yd2/topBlockList?date=${date}&type=2`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取主线板块列表(人选)失败');
                }
                topBlockAvgPctDataManual = data.data.topBlockAvgPctDTO;
                // 处理数据，将 changePctDTO 的字段平铺到主对象
                topBlocksDataManual = (data.data.topBlockDTOList || []).map((block, index) => {
                    const changePctDTO = block.changePctDTO || {};
                    return {
                        rank: index + 1, // 添加序号
                        blockCode: block.blockCode,
                        blockName: block.blockName,
                        topDays: block.topDays,
                        topStockSize: block.topStockSize,
                        topStockList: Array.isArray(block.topStockList) && block.topStockList.length > 0
                            // ? block.topStockList.map(s => `${s.stockName} (${s.topDays}天)`).join(', ')
                            ? block.topStockList.map(s => stockLink(s.xueqiuMarket, s.stockCode, s.stockName, s.topDays)).join(', ')
                            : '-',
                        topStartDate: changePctDTO.topStartDate || '-',
                        topEndDate: changePctDTO.topEndDate || '-',
                        start2Today_changePct: changePctDTO.start2Today_changePct || 0,
                        start2End_changePct: changePctDTO.start2End_changePct || 0,
                        start2Max_changePct: changePctDTO.start2Max_changePct || 0,
                        today2Next_changePct: changePctDTO.today2Next_changePct || 0,
                        today2End_changePct: changePctDTO.today2End_changePct || 0,
                        today2Max_changePct: changePctDTO.today2Max_changePct || 0,
                        start2Next_changePct: changePctDTO.start2Next_changePct || 0,
                        start2Next3_changePct: changePctDTO.start2Next3_changePct || 0,
                        start2Next5_changePct: changePctDTO.start2Next5_changePct || 0,
                        start2Next10_changePct: changePctDTO.start2Next10_changePct || 0,
                        start2Next15_changePct: changePctDTO.start2Next15_changePct || 0,
                        start2Next20_changePct: changePctDTO.start2Next20_changePct || 0,
                    };
                });

                if (!topBlocksDataManual || topBlocksDataManual.length === 0) {
                    messageDiv.style.display = 'block';
                    messageDiv.textContent = '暂无数据';
                    document.getElementById('topBlocksManualCardTitle').textContent = `主线板块列表（人选）（${date}）（0）`;
                    // 移除平均值行
                    const thead = document.querySelector('#topBlocksTableManual thead');
                    if (thead) {
                        const existingAvgRow = thead.querySelector('tr.avg-row');
                        if (existingAvgRow) {
                            existingAvgRow.remove();
                        }
                    }
                    return;
                }
                // 渲染平均值行
                displayTopBlocksAvgRowManual(topBlockAvgPctDataManual);
                // 根据当前排序状态显示数据
                displayTopBlocksManual(topBlocksDataManual);
            })
            .catch(error => {
                console.error('获取主线板块列表(人选)失败:', error);
                tbody.innerHTML = '<tr><td colspan="14">加载失败：' + error.message + '</td></tr>';
                document.getElementById('topBlocksManualCardTitle').textContent = `主线板块列表（人选）（${date}）（0）`;
            });
    }


    // 展示
    function displayTopBlocksManual(blocks) {
        const tbody = document.querySelector('#topBlocksTableManual tbody');
        const messageDiv = document.getElementById('topBlocksTableManualMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topBlocksTableManual tbody 或 #topBlocksTableManualMessage');
            return;
        }
        let sortedBlocks = [...blocks];
        if (topBlocksSortStateManual.column) {
            sortedBlocks.sort((a, b) => {
                let valA = a[topBlocksSortStateManual.column];
                let valB = b[topBlocksSortStateManual.column];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                // number
                if (typeof valA === 'number') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return topBlocksSortStateManual.order === 'asc' ? numA - numB : numB - numA;
                    }
                }
                // string
                const comparison = String(valA).localeCompare(String(valB));
                return topBlocksSortStateManual.order === 'asc' ? comparison : -comparison;
            });
        }
        tbody.innerHTML = '';
        if (sortedBlocks.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无数据';
            document.getElementById('topBlocksManualCardTitle').textContent = `主线板块列表（人选）（${topBlocksCurrentDateManual}）（0）`;
        } else {
            messageDiv.style.display = 'none';
            sortedBlocks.forEach((block) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${block.rank}</td>
                    <td>${block.blockCode}</td>
                    <td>${block.blockName}</td>
                    <td>${block.topDays}</td>
                    <td>${block.topStockSize}</td>
                    <td class="top-list-item">${block.topStockList}</td>
                    <td>${block.topStartDate}</td>
                    <td>${block.topEndDate}</td>
                    <td style="color: ${block.start2Today_changePct > 0 ? 'red' : block.start2Today_changePct < 0 ? 'teal' : 'black'}">${block.start2Today_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2End_changePct > 0 ? 'red' : block.start2End_changePct < 0 ? 'teal' : 'black'}">${block.start2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Max_changePct > 0 ? 'red' : block.start2Max_changePct < 0 ? 'teal' : 'black'}">${block.start2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2Next_changePct > 0 ? 'red' : block.today2Next_changePct < 0 ? 'teal' : 'black'}">${block.today2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2End_changePct > 0 ? 'red' : block.today2End_changePct < 0 ? 'teal' : 'black'}">${block.today2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.today2Max_changePct > 0 ? 'red' : block.today2Max_changePct < 0 ? 'teal' : 'black'}">${block.today2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next_changePct > 0 ? 'red' : block.start2Next_changePct < 0 ? 'teal' : 'black'}">${block.start2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next3_changePct > 0 ? 'red' : block.start2Next3_changePct < 0 ? 'teal' : 'black'}">${block.start2Next3_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next5_changePct > 0 ? 'red' : block.start2Next5_changePct < 0 ? 'teal' : 'black'}">${block.start2Next5_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next10_changePct > 0 ? 'red' : block.start2Next10_changePct < 0 ? 'teal' : 'black'}">${block.start2Next10_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next15_changePct > 0 ? 'red' : block.start2Next15_changePct < 0 ? 'teal' : 'black'}">${block.start2Next15_changePct.toFixed(2)}%</td>
                    <td style="color: ${block.start2Next20_changePct > 0 ? 'red' : block.start2Next20_changePct < 0 ? 'teal' : 'black'}">${block.start2Next20_changePct.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('topBlocksManualCardTitle').textContent = `主线板块列表（人选）（${topBlockAvgPctDataManual.date}）（${sortedBlocks.length}）`;
        }
    }

    function displayTopBlocksAvgRowManual(avgPct) {
        const thead = document.querySelector('#topBlocksTableManual thead');
        if (!thead) {
            console.error('未找到 #topBlocksTable thead');
            return;
        }

        // 清除可能已存在的平均值行
        const existingAvgRow = document.querySelector('#topBlocksTableManual thead tr.avg-row');
        if (existingAvgRow) {
            existingAvgRow.remove();
        }

        const avgRow = document.createElement('tr');
        avgRow.className = 'avg-row'; // 添加类名以便样式控制

        // 前8列是基本信息，需要合并显示标签
        avgRow.innerHTML = `
            <td colspan="8" class="text-center avg-label">【指数】平均值</td>
            <td style="color: ${avgPct.start2Today_changePct > 0 ? 'red' : avgPct.start2Today_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Today_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2End_changePct > 0 ? 'red' : avgPct.start2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Max_changePct > 0 ? 'red' : avgPct.start2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Next_changePct > 0 ? 'red' : avgPct.today2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2End_changePct > 0 ? 'red' : avgPct.today2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Max_changePct > 0 ? 'red' : avgPct.today2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next_changePct > 0 ? 'red' : avgPct.start2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next3_changePct > 0 ? 'red' : avgPct.start2Next3_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next3_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next5_changePct > 0 ? 'red' : avgPct.start2Next5_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next5_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next10_changePct > 0 ? 'red' : avgPct.start2Next10_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next10_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next15_changePct > 0 ? 'red' : avgPct.start2Next15_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next15_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next20_changePct > 0 ? 'red' : avgPct.start2Next20_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next20_changePct.toFixed(2)}%
            </td>
        `;

        // 将平均值行插入到原始表头行之后
        thead.appendChild(avgRow);
    }


    // 排序
    function sortTopBlocksTableManual(column) {
        if (topBlocksSortStateManual.column === column) {
            topBlocksSortStateManual.order = topBlocksSortStateManual.order === 'asc' ? 'desc' : 'asc';
        } else {
            topBlocksSortStateManual.order = 'desc'; // 默认倒序
            topBlocksSortStateManual.column = column;
        }
        updateTopBlocksSortIconManual();
        displayTopBlocksManual(topBlocksDataManual);
    }

    function updateTopBlocksSortIconManual() {
        const iconIdPrefix = `sortTopBlocksManual${topBlocksSortStateManual.column ? topBlocksSortStateManual.column.charAt(0).toUpperCase() + topBlocksSortStateManual.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);
        const allIcons = document.querySelectorAll('#topBlocksTableManual th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });
        if (iconElement && topBlocksSortStateManual.column) {
            iconElement.textContent = topBlocksSortStateManual.order === 'asc' ? '↑' : '↓';
        }
    }


    // ----------------------------------------- 主线个股 列表（人选）-----------------------------------------------------


    // 加载
    function loadTopStocksManual(date = topStocksCurrentDateManual) {
        const tbody = document.querySelector('#topStocksTableManual tbody');
        const messageDiv = document.getElementById('topStocksTableManualMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topStocksTableManual tbody 或 #topStocksTableManualMessage');
            return;
        }
        // 清空内容
        tbody.innerHTML = '';
        messageDiv.style.display = 'none';
        ApiUtils.fetch(`/api/topBlock/bk-yd2/topStockList?date=${date}&type=2`)
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取主线个股列表(人选)失败');
                }
                topStockAvgPctDataManual = data.data.topStockAvgPctDTO;
                // 处理数据，将 changePctDTO 的字段平铺到主对象
                topStocksDataManual = (data.data.topStockDTOList || []).map((stock, index) => {
                    const changePctDTO = stock.changePctDTO || {};
                    return {
                        rank: index + 1, // 添加序号
                        stockCode: stock.stockCode,
                        stockName: stock.stockName,
                        xueqiuMarket: stock.xueqiuMarket,
                        topDays: stock.topDays,
                        topBlockSize: stock.topBlockSize,
                        topBlockList: Array.isArray(stock.topBlockList) && stock.topBlockList.length > 0
                            ? stock.topBlockList.map(b => `${b.blockName} (${b.topDays}天)`).join(', ')
                            : '-',
                        topStartDate: changePctDTO.topStartDate || '-',
                        topEndDate: changePctDTO.topEndDate || '-',
                        start2Today_changePct: changePctDTO.start2Today_changePct || 0,
                        start2End_changePct: changePctDTO.start2End_changePct || 0,
                        start2Max_changePct: changePctDTO.start2Max_changePct || 0,
                        today2Next_changePct: changePctDTO.today2Next_changePct || 0,
                        today2End_changePct: changePctDTO.today2End_changePct || 0,
                        today2Max_changePct: changePctDTO.today2Max_changePct || 0,
                        start2Next_changePct: changePctDTO.start2Next_changePct || 0,
                        start2Next3_changePct: changePctDTO.start2Next3_changePct || 0,
                        start2Next5_changePct: changePctDTO.start2Next5_changePct || 0,
                        start2Next10_changePct: changePctDTO.start2Next10_changePct || 0,
                        start2Next15_changePct: changePctDTO.start2Next15_changePct || 0,
                        start2Next20_changePct: changePctDTO.start2Next20_changePct || 0,
                    };
                });

                if (!topStocksDataManual || topStocksDataManual.length === 0) {
                    messageDiv.style.display = 'block';
                    messageDiv.textContent = '暂无数据';
                    document.getElementById('topStocksManualCardTitle').textContent = `主线个股列表（人选）（${date}）（0）`;
                    // 移除平均值行
                    const thead = document.querySelector('#topStocksTableManual thead');
                    if (thead) {
                        const existingAvgRow = thead.querySelector('tr.avg-row');
                        if (existingAvgRow) {
                            existingAvgRow.remove();
                        }
                    }
                    return;
                }
                // 渲染平均值行
                displayTopStocksAvgRowManual(topStockAvgPctDataManual);
                // 根据当前排序状态显示数据
                displayTopStocksManual(topStocksDataManual);
            })
            .catch(error => {
                console.error('获取主线个股列表(人选)失败:', error);
                tbody.innerHTML = '<tr><td colspan="14">加载失败：' + error.message + '</td></tr>';
                document.getElementById('topStocksManualCardTitle').textContent = `主线个股列表（人选）（${date}）（0）`;
            });
    }


    // 展示
    function displayTopStocksManual(stocks) {
        const tbody = document.querySelector('#topStocksTableManual tbody');
        const messageDiv = document.getElementById('topStocksTableManualMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #topStocksTableManual tbody 或 #topStocksTableManualMessage');
            return;
        }
        let sortedStocks = [...stocks];
        if (topStocksSortStateManual.column) {
            sortedStocks.sort((a, b) => {
                let valA = a[topStocksSortStateManual.column];
                let valB = b[topStocksSortStateManual.column];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                // number
                if (typeof valA === 'number') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return topStocksSortStateManual.order === 'asc' ? numA - numB : numB - numA;
                    }
                }
                // string
                const comparison = String(valA).localeCompare(String(valB));
                return topStocksSortStateManual.order === 'asc' ? comparison : -comparison;
            });
        }
        tbody.innerHTML = '';
        if (sortedStocks.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无数据';
            document.getElementById('topStocksManualCardTitle').textContent = `主线个股列表（人选）（${topStocksCurrentDateManual}）（0）`;
        } else {
            messageDiv.style.display = 'none';
            sortedStocks.forEach((stock) => {
                const stockLink = `https://xueqiu.com/S/${stock.xueqiuMarket}${stock.stockCode}`;
                const tr = document.createElement('tr');
                // 添加 data-stockcode 属性
                tr.setAttribute('data-stockcode', stock.stockCode);
                tr.innerHTML = `
                    <td><input type="checkbox" class="top-stocks-manual-checkbox" data-stockcode="${stock.stockCode}"></td>
                    <td>${stock.rank}</td>
                    <td><a href="${stockLink}" target="_blank" class="stock-code-link">${stock.stockCode}</a></td>
                    <td>${stock.stockName}</td>
                    <td>${stock.topDays}</td>
                    <td>${stock.topBlockSize}</td>
                    <td class="top-list-item">${stock.topBlockList}</td>
                    <td>${stock.topStartDate}</td>
                    <td>${stock.topEndDate.toString()}</td>
                    <td style="color: ${stock.start2Today_changePct > 0 ? 'red' : stock.start2Today_changePct < 0 ? 'teal' : 'black'}">${stock.start2Today_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2End_changePct > 0 ? 'red' : stock.start2End_changePct < 0 ? 'teal' : 'black'}">${stock.start2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Max_changePct > 0 ? 'red' : stock.start2Max_changePct < 0 ? 'teal' : 'black'}">${stock.start2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2Next_changePct > 0 ? 'red' : stock.today2Next_changePct < 0 ? 'teal' : 'black'}">${stock.today2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2End_changePct > 0 ? 'red' : stock.today2End_changePct < 0 ? 'teal' : 'black'}">${stock.today2End_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.today2Max_changePct > 0 ? 'red' : stock.today2Max_changePct < 0 ? 'teal' : 'black'}">${stock.today2Max_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next_changePct > 0 ? 'red' : stock.start2Next_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next3_changePct > 0 ? 'red' : stock.start2Next3_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next3_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next5_changePct > 0 ? 'red' : stock.start2Next5_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next5_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next10_changePct > 0 ? 'red' : stock.start2Next10_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next10_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next15_changePct > 0 ? 'red' : stock.start2Next15_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next15_changePct.toFixed(2)}%</td>
                    <td style="color: ${stock.start2Next20_changePct > 0 ? 'red' : stock.start2Next20_changePct < 0 ? 'teal' : 'black'}">${stock.start2Next20_changePct.toFixed(2)}%</td>
                    <td><button class="btn btn-danger btn-sm btn-stockManual-delete-row" data-stockcode="${stock.stockCode}">删除</button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('topStocksManualCardTitle').textContent = `主线个股列表（人选）（${topStockAvgPctDataManual.date}）（${sortedStocks.length}）`;

            // 为新渲染的复选框添加事件监听器
            attachTopStocksManualCheckboxListeners();
        }
    }

    function displayTopStocksAvgRowManual(avgPct) {
        const thead = document.querySelector('#topStocksTableManual thead');
        if (!thead) {
            console.error('未找到 #topStocksTableManual thead');
            return;
        }

        // 清除可能已存在的平均值行
        const existingAvgRow = document.querySelector('#topStocksTableManual thead tr.avg-row');
        if (existingAvgRow) {
            existingAvgRow.remove();
        }

        const avgRow = document.createElement('tr');
        avgRow.className = 'avg-row'; // 添加类名以便样式控制

        // 前8列是基本信息，需要合并显示标签
        avgRow.innerHTML = `
            <td colspan="9" class="text-center avg-label">【指数】平均值</td>
            <td style="color: ${avgPct.start2Today_changePct > 0 ? 'red' : avgPct.start2Today_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Today_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2End_changePct > 0 ? 'red' : avgPct.start2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Max_changePct > 0 ? 'red' : avgPct.start2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Next_changePct > 0 ? 'red' : avgPct.today2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2End_changePct > 0 ? 'red' : avgPct.today2End_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2End_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.today2Max_changePct > 0 ? 'red' : avgPct.today2Max_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.today2Max_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next_changePct > 0 ? 'red' : avgPct.start2Next_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next3_changePct > 0 ? 'red' : avgPct.start2Next3_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next3_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next5_changePct > 0 ? 'red' : avgPct.start2Next5_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next5_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next10_changePct > 0 ? 'red' : avgPct.start2Next10_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next10_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next15_changePct > 0 ? 'red' : avgPct.start2Next15_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next15_changePct.toFixed(2)}%
            </td>
            <td style="color: ${avgPct.start2Next20_changePct > 0 ? 'red' : avgPct.start2Next20_changePct < 0 ? 'teal' : 'black'};">
                ${avgPct.start2Next20_changePct.toFixed(2)}%
            </td>
            <td>-</td>
        `;

        // 将平均值行插入到原始表头行之后
        thead.appendChild(avgRow);
    }


    // 排序
    function updateTopStocksSortIconManual() {
        const iconIdPrefix = `sortTopStocksManual${topStocksSortStateManual.column ? topStocksSortStateManual.column.charAt(0).toUpperCase() + topStocksSortStateManual.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);
        const allIcons = document.querySelectorAll('#topStocksTableManual th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });
        if (iconElement && topStocksSortStateManual.column) {
            iconElement.textContent = topStocksSortStateManual.order === 'asc' ? '↑' : '↓';
        }
    }

    function sortTopStocksTableManual(column) {
        if (topStocksSortStateManual.column === column) {
            topStocksSortStateManual.order = topStocksSortStateManual.order === 'asc' ? 'desc' : 'asc';
        } else {
            topStocksSortStateManual.order = 'desc'; // 默认倒序
            topStocksSortStateManual.column = column;
        }
        updateTopStocksSortIconManual();
        displayTopStocksManual(topStocksDataManual);
    }


    // ------- 主线个股（人选）：支持勾选（等比买入 / 批量删除）


    // 主线个股（人选）  ->   复选框 事件监听
    function attachTopStocksManualCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.top-stocks-manual-checkbox');
        const selectAllCheckbox = document.getElementById('topStocksManualSelectAllCheckboxHeader');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTopStocksManualSelectAllState);
        });

        // 全选/取消全选事件
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                const isChecked = this.checked;
                const checkboxes = document.querySelectorAll('.top-stocks-manual-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                // 更新半选状态图标
                updateTopStocksManualSelectAllState();
            });
        }
    }

    // 主线个股（人选）  ->   全选/取消全选
    function updateTopStocksManualSelectAllState() {
        const checkboxes = document.querySelectorAll('.top-stocks-manual-checkbox');
        const selectAllCheckbox = document.getElementById('topStocksManualSelectAllCheckboxHeader');
        if (!selectAllCheckbox) return; // 防止找不到元素报错

        const checkedBoxes = document.querySelectorAll('.top-stocks-manual-checkbox:checked');
        const totalBoxes = checkboxes.length;

        if (totalBoxes === 0) {
            // 如果没有可选项，全选框应为未选中且非半选
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length === totalBoxes) {
            // 全部选中
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            // 部分选中
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            // 全部未选中
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }


    // ------- 主线个股（人选）：一键等比买入（支持勾选）

    // 1. 按钮
    function handleBuyNewPosition() {
        const selectedCheckboxes = document.querySelectorAll('.top-stocks-manual-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一只股票进行买入！');
            return;
        }
        // 重置模态框内的输入
        document.getElementById('modalBuyPosPctInput').value = '100';
        document.getElementById('modalBuyCurrPricePctInput').value = '0';
        document.getElementById('modalBuyChangePricePctInput').value = '0';
        // 默认选择当前价格策略
        document.getElementById('modalStrategyBuyCurrPrice').checked = true;
        document.getElementById('modalBuyChangePricePctInput').disabled = true; // 禁用另一个输入框
        document.getElementById('modalBuyCurrPricePctInput').disabled = false; // 启用当前输入框

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('buyNewPositionSettingsModal'));
        modal.show();
    }

    // 2. 价格策略单选按钮互斥事件
    function setupBuyPriceStrategyToggle() {
        const currPriceRadio = document.getElementById('modalStrategyBuyCurrPrice');
        const changePriceRadio = document.getElementById('modalStrategyBuyChangePrice');
        const currPriceInput = document.getElementById('modalBuyCurrPricePctInput');
        const changePriceInput = document.getElementById('modalBuyChangePricePctInput');

        if (currPriceRadio && changePriceRadio && currPriceInput && changePriceInput) {
            function handleRadioChange() {
                if (currPriceRadio.checked) {
                    currPriceInput.disabled = false;
                    changePriceInput.disabled = true;
                } else if (changePriceRadio.checked) {
                    currPriceInput.disabled = true;
                    changePriceInput.disabled = false;
                }
            }

            currPriceRadio.addEventListener('change', handleRadioChange);
            changePriceRadio.addEventListener('change', handleRadioChange);

            // 初始化状态
            handleRadioChange();
        }
    }

    // 3. 确认按钮点击事件：执行买入操作
    function executeBuyNewPosition() {
        const selectedCheckboxes = document.querySelectorAll('.top-stocks-manual-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一只股票进行买入！');
            return;
        }

        const buyStockCodes = [];
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                const stockCode = row.getAttribute('data-stockcode'); // 假设行上存储了股票代码
                if (stockCode) {
                    buyStockCodes.push(stockCode);
                }
            }
        });

        if (buyStockCodes.length === 0) {
            alert('未能获取到选中股票的代码，请重试！');
            return;
        }

        // - 读取模态框设置 -
        const buyPosPctInput = document.getElementById('modalBuyPosPctInput');
        let buyPosPct = parseFloat(buyPosPctInput.value);
        if (isNaN(buyPosPct) || buyPosPct < 0 || buyPosPct > 100) {
            alert('请输入有效的 买入总仓位比例 (0-100%)');
            buyPosPctInput.focus();
            return;
        }

        let currPricePct = 0;
        let changePricePct = 0;
        const selectedStrategy = document.querySelector('input[name="modalBuyPriceStrategy"]:checked').value;

        if (selectedStrategy === 'currPricePct') {
            const currPricePctInput = document.getElementById('modalBuyCurrPricePctInput');
            currPricePct = parseFloat(currPricePctInput.value);
            if (isNaN(currPricePct) || currPricePct < -30 || currPricePct > 30) {
                alert('请输入有效的当前价格涨跌幅比例 (-30% 到 30%)');
                currPricePctInput.focus();
                return;
            }
        } else if (selectedStrategy === 'changePricePct') {
            const changePricePctInput = document.getElementById('modalBuyChangePricePctInput');
            changePricePct = parseFloat(changePricePctInput.value);
            if (isNaN(changePricePct) || changePricePct < -30 || changePricePct > 30) {
                alert('请输入有效的昨日收盘价涨跌幅比例 (-30% 到 30%)');
                changePricePctInput.focus();
                return;
            }
        }
        // - 结束读取模态框设置 -

        // - 更新确认消息 -
        let confirmMsg = `您确定要买入以下【${buyStockCodes.length}】只股票吗？`;
        confirmMsg += `\n买入总仓位比例: ${buyPosPct}%`;
        if (selectedStrategy === 'currPricePct' && currPricePct !== 0) {
            confirmMsg += `\n价格策略: 当前价格【${currPricePct > 0 ? '+' : ''}${currPricePct}%】`;
        } else if (selectedStrategy === 'changePricePct' && changePricePct !== 0) {
            confirmMsg += `\n价格策略: 昨日收盘价【${changePricePct > 0 ? '+' : ''}${changePricePct}%】`;
        }
        confirmMsg += `\n\n股票代码: ${buyStockCodes.join(', ')}`;
        // - 结束更新确认消息 -

        if (!confirm(confirmMsg)) {
            return;
        }

        const buyStockCodeList = buyStockCodes.join(',');
        const originalBtnText = document.getElementById('confirmBuyNewPositionSettingsBtn').textContent;
        document.getElementById('confirmBuyNewPositionSettingsBtn').textContent = '处理中...';
        document.getElementById('confirmBuyNewPositionSettingsBtn').disabled = true;

        ApiUtils.fetch(`/api/trade/quick/eqRatio/keepExistBuyNew?buyStockCodeList=${buyStockCodeList}&buyPosPct=${buyPosPct}&currPricePct=${currPricePct}&changePricePct=${changePricePct}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(res => {
            return res.ok ? res.json() : res.json().then(errData => {
                throw new Error(errData.msg || `HTTP error! status: ${res.status}`);
            });
        }).then(data => {
            if (data && data.success) {
                alert(`【一键等比买入（调仓换股）】操作成功！`);
                // 可选：刷新持仓或主线个股数据
                loadPositions(); // 如果需要 刷新持仓
                loadTopStocksManual(); // 如果需要 刷新主线个股（人选）
            } else {
                const errorMsg = data.msg || '操作失败，未知错误。';
                alert(`【一键等比买入（调仓换股）】失败：${errorMsg}`);
                console.error('Buy New Position API Error:', data);
            }
        }).catch(error => {
            console.error('【一键等比买入（调仓换股）】请求失败:', error);
            alert(`【一键等比买入（调仓换股）】请求失败：${error.message || error}`);
        }).finally(() => {
            document.getElementById('confirmBuyNewPositionSettingsBtn').textContent = originalBtnText;
            document.getElementById('confirmBuyNewPositionSettingsBtn').disabled = false;
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('buyNewPositionSettingsModal'));
            if (modal) {
                modal.hide();
            }
        });
    }


    // 主线个股（人选）- 删除（单个）
    function deleteTopStockManual(stockCode, buttonElement) {
        const date = topStockAvgPctDataManual.date;

        if (!confirm(`确定要删除股票代码 ${stockCode} 的记录吗？`)) {
            return;
        }

        buttonElement.textContent = '删除中...';
        buttonElement.disabled = true;

        // Call the API
        ApiUtils.fetch(`/api/topBlock/bk-yd2/topStockList/delete?date=${date}&stockCodeList=${encodeURIComponent(stockCode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`成功删除记录 ${stockCode}。`);
                    loadTopStocksManual(date);
                } else {
                    alert(`删除失败：${data.msg || '未知错误'}`);
                    console.error('Delete failed for stock:', stockCode, data);
                }
            })
            .catch(error => {
                console.error('删除主线个股列表（人选）单行失败:', stockCode, error);
                alert(`删除请求失败：${error.message || error}`);
            });
    }

    // 主线个股（人选）- 批量删除
    function batchDeleteTopStocksManual() {
        const checkboxes = document.querySelectorAll('#topStocksTableManual tbody input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            alert('请至少勾选一项进行删除。');
            return;
        }

        const stockCodes = Array.from(checkboxes)
            .map(checkbox => checkbox.getAttribute('data-stockcode'))
            .filter(code => code); // Filter out any potentially missing codes

        if (stockCodes.length === 0) {
            alert('获取勾选的股票代码失败。');
            console.error('No stock codes found for selected items.');
            return;
        }

        const stockCodeList = stockCodes.join(',');
        const date = topStockAvgPctDataManual.date;

        if (!confirm(`确定要删除 ${stockCodes.length} 条主线个股记录吗？`)) {
            return; // User cancelled
        }

        // Call the API
        ApiUtils.fetch(`/api/topBlock/bk-yd2/topStockList/delete?date=${date}&stockCodeList=${encodeURIComponent(stockCodeList)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`成功删除 ${data.data || stockCodes.length} 条记录。`);
                    // Reload the table data to reflect changes
                    loadTopStocksManual(date);
                } else {
                    alert(`删除失败：${data.msg || '未知错误'}`);
                    console.error('Batch delete failed:', data);
                }
            })
            .catch(error => {
                console.error('删除主线个股列表（人选）失败:', error);
                alert(`删除请求失败：${error.message || error}`);
            });
    }


    // ----------------------------------------- 按钮事件 ---------------------------------------------------------------


    // 将所有页面 初始化相关的事件监听器 和 数据加载   都放入 DOMContentLoaded 内
    document.addEventListener('DOMContentLoaded', function () {


        // -------------------------- 一键 B/S 按钮


        // 查询（持仓）
        document.getElementById('loadPositionsButton').addEventListener('click', loadPositions);

        // 一键再融资
        document.getElementById('quickResetFinancingButton').addEventListener('click', handleQuickResetFinancing);

        // 一键取款 主按钮
        document.getElementById('quickLowerFinancingButton').addEventListener('click', handleQuickLowerFinancing);
        // 一键取款 确认按钮
        document.getElementById('confirmQuickLowerFinancingBtn').addEventListener('click', confirmQuickLowerFinancing);


        // --- 一键等比卖出 ---

        // 主按钮
        document.getElementById('sellPositionsButton').addEventListener('click', handleSellPositions);
        // 价格策略（互斥单选）
        document.getElementById('modalStrategyCurrPrice').addEventListener('change', updateModalInputStates);   // 当前价格
        document.getElementById('modalStrategyChangePrice').addEventListener('change', updateModalInputStates); // 昨日收盘价
        // 确认按钮
        document.getElementById('confirmSellSettingsBtn').addEventListener('click', executeSellAll);


        // --- 一键等比买入 ---

        // 主按钮
        document.getElementById('buyNewPositionButton').addEventListener('click', handleBuyNewPosition);
        // 价格策略（互斥单选）
        setupBuyPriceStrategyToggle();
        // 确认按钮
        document.getElementById('confirmBuyNewPositionSettingsBtn').addEventListener('click', executeBuyNewPosition);


        // -------------------------- 配置-持仓账户


        // 持仓账户配置 事件监听器
        document.getElementById('saveCfgAccountBtn').addEventListener('click', saveCfgAccount);


        // -------------------------- 主线 板块/个股（机选）


        // 主线板块/个股   日期、刷新 按钮事件
        const topBlocksDateInput = document.getElementById('topBlocksDateInput');
        const topStocksDateInput = document.getElementById('topStocksDateInput');
        const refreshTopBlocksButton = document.getElementById('refreshTopBlocksButton');
        const refreshTopStocksButton = document.getElementById('refreshTopStocksButton');


        if (topBlocksDateInput) {
            topBlocksDateInput.max = today;
            // 设置默认日期
            topBlocksDateInput.value = topBlocksCurrentDate;
            // 添加日期改变事件
            topBlocksDateInput.addEventListener('change', function () {
                topBlocksCurrentDate = this.value;
                loadTopBlocks(topBlocksCurrentDate);
            });
            // 添加刷新按钮事件
            if (refreshTopBlocksButton) {
                refreshTopBlocksButton.addEventListener('click', () => loadTopBlocks(topBlocksCurrentDate));
            }
        }

        if (topStocksDateInput) {
            topStocksDateInput.max = today;
            // 设置默认日期
            topStocksDateInput.value = topStocksCurrentDate;
            // 添加日期改变事件
            topStocksDateInput.addEventListener('change', function () {
                topStocksCurrentDate = this.value;
                loadTopStocks(topStocksCurrentDate);
            });
            // 添加刷新按钮事件
            if (refreshTopStocksButton) {
                refreshTopStocksButton.addEventListener('click', () => loadTopStocks(topStocksCurrentDate));
            }
        }


        // -------------------------- 主线 板块/个股（人选）


        // 主线板块/个股   日期、刷新 按钮事件
        const topBlocksManualDateInput = document.getElementById('topBlocksManualDateInput');
        const topStocksManualDateInput = document.getElementById('topStocksManualDateInput');
        const refreshTopBlocksManualButton = document.getElementById('refreshTopBlocksManualButton');
        const refreshTopStocksManualButton = document.getElementById('refreshTopStocksManualButton');


        if (topBlocksManualDateInput) {
            topBlocksManualDateInput.max = today;
            topBlocksManualDateInput.value = topBlocksCurrentDateManual;
            topBlocksManualDateInput.addEventListener('change', function () {
                topBlocksCurrentDateManual = this.value;
                loadTopBlocksManual(topBlocksCurrentDateManual);
            });
            if (refreshTopBlocksManualButton) {
                refreshTopBlocksManualButton.addEventListener('click', () => loadTopBlocksManual(topBlocksCurrentDateManual));
            }
        }

        if (topStocksManualDateInput) {
            topStocksManualDateInput.max = today;
            topStocksManualDateInput.value = topStocksCurrentDateManual;
            topStocksManualDateInput.addEventListener('change', function () {
                topStocksCurrentDateManual = this.value;
                loadTopStocksManual(topStocksCurrentDateManual);
            });
            if (refreshTopStocksManualButton) {
                refreshTopStocksManualButton.addEventListener('click', () => loadTopStocksManual(topStocksCurrentDateManual));
            }
        }


        // --- 新增：主线板块/个股标签页 首次显示加载数据 ---
        const topBlocksTab = document.getElementById('top-blocks-tab');
        const topStocksTab = document.getElementById('top-stocks-tab');
        const topBlocksManualTab = document.getElementById('top-blocks-manual-tab');
        const topStocksManualTab = document.getElementById('top-stocks-manual-tab');

        let hasLoadedTopBlocks = false;
        let hasLoadedTopStocks = false;
        let hasLoadedTopBlocksManual = false;
        let hasLoadedTopStocksManual = false;


        // 机选
        if (topBlocksTab) {
            topBlocksTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedTopBlocks) {
                    loadTopBlocks(topBlocksCurrentDate); // 使用当前日期
                    hasLoadedTopBlocks = true;
                }
            });
        }
        if (topStocksTab) {
            topStocksTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedTopStocks) {
                    loadTopStocks(topStocksCurrentDate); // 使用当前日期
                    hasLoadedTopStocks = true;
                }
            });
        }


        // 人选
        if (topBlocksManualTab) {
            topBlocksManualTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedTopBlocksManual) {
                    loadTopBlocksManual(topBlocksCurrentDateManual); // 使用当前日期
                    hasLoadedTopBlocksManual = true;
                }
            });
        }
        if (topStocksManualTab) {
            topStocksManualTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedTopStocksManual) {
                    loadTopStocksManual(topStocksCurrentDateManual); // 使用当前日期
                    hasLoadedTopStocksManual = true;
                }
            });
        }


        // --- 持仓表格全选优化 ---
        // Modified: Use the new header checkbox for positions
        const positionsSelectAllCheckboxHeader = document.getElementById('positionSelectAllCheckboxHeader');
        // Select the header cell containing the new checkbox for positions
        const positionsCheckboxHeaderCell = document.querySelector('#positionTable thead th:first-child');
        if (positionsCheckboxHeaderCell && positionsSelectAllCheckboxHeader) {
            positionsCheckboxHeaderCell.style.cursor = 'pointer'; // 可选：改变鼠标样式提示可点击
            positionsCheckboxHeaderCell.addEventListener('click', function (event) {
                // Prevent double triggering if the checkbox itself is clicked
                if (event.target !== positionsSelectAllCheckboxHeader) {
                    positionsSelectAllCheckboxHeader.checked = !positionsSelectAllCheckboxHeader.checked;
                    // Manually trigger the change event to execute the logic
                    positionsSelectAllCheckboxHeader.dispatchEvent(new Event('change'));
                }
            });
        }


        // --- 当日委托表格全选优化 ---
        // Modified: Use the new header checkbox for orders
        const ordersSelectAllCheckboxHeader = document.getElementById('ordersSelectAllCheckboxHeader');
        // Select the header cell containing the new checkbox for orders
        const ordersCheckboxHeaderCell = document.querySelector('#ordersTable thead th:first-child');
        if (ordersCheckboxHeaderCell && ordersSelectAllCheckboxHeader) {
            ordersCheckboxHeaderCell.style.cursor = 'pointer'; // 可选：改变鼠标样式提示可点击
            ordersCheckboxHeaderCell.addEventListener('click', function (event) {
                // Prevent double triggering if the checkbox itself is clicked
                if (event.target !== ordersSelectAllCheckboxHeader) {
                    ordersSelectAllCheckboxHeader.checked = !ordersSelectAllCheckboxHeader.checked;
                    // Manually trigger the change event to execute the logic
                    ordersSelectAllCheckboxHeader.dispatchEvent(new Event('change'));
                }
            });
        }


        // --- 当日委托相关元素和事件 ---
        const ordersTab = document.getElementById('orders-tab');
        const filterStatus = document.getElementById('filterStatus');
        const filterDirection = document.getElementById('filterDirection');
        const refreshOrdersButton = document.getElementById('refreshOrdersButton');
        const batchCancelOrdersButton = document.getElementById('batchCancelOrdersButton');
        const quickCancelOrdersButton = document.getElementById('quickCancelOrdersButton');


        // - 新增：为日期范围输入框添加默认值和事件监听 -
        const startDateInput = document.getElementById('ordersStartDateInput');
        const endDateInput = document.getElementById('ordersEndDateInput');

        if (startDateInput && endDateInput && refreshOrdersButton) {
            // 设置默认日期为今日
            startDateInput.value = ordersStartDate;
            endDateInput.value = ordersEndDate;

            // 日期改变时，重新加载数据
            startDateInput.addEventListener('change', loadOrders);
            endDateInput.addEventListener('change', loadOrders);
        }


        if (ordersTab && filterStatus && filterDirection && refreshOrdersButton) {
            let hasLoadedOrders = false;
            ordersTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedOrders) {
                    loadOrders();
                    hasLoadedOrders = true;
                }
            });
            refreshOrdersButton.addEventListener('click', loadOrders);
            filterStatus.addEventListener('change', () => displayOrders(ordersData));
            filterDirection.addEventListener('change', () => displayOrders(ordersData));
            // --- 现有代码：当日委托按钮事件 ---
            if (batchCancelOrdersButton) {
                batchCancelOrdersButton.addEventListener('click', handleBatchCancelOrders);
            }
            if (quickCancelOrdersButton) {
                quickCancelOrdersButton.addEventListener('click', handleQuickCancelOrder);
            }
            // --- 现有代码：当日委托全选复选框事件 (Modified to use new header checkbox) ---
            if (ordersSelectAllCheckboxHeader) { // Use new header checkbox
                ordersSelectAllCheckboxHeader.removeEventListener('change', handleOrdersSelectAllChange); // Remove potential old listener on new element
                ordersSelectAllCheckboxHeader.addEventListener('change', handleOrdersSelectAllChange); // Add listener to new header checkbox
                // 为订单复选框添加监听，以便更新全选按钮状态
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.type === 'childList') {
                            document.querySelectorAll('#ordersTable .order-checkbox').forEach(cb => {
                                cb.removeEventListener('change', updateOrdersSelectAllState);
                                cb.addEventListener('change', updateOrdersSelectAllState);
                            });
                        }
                    });
                });
                const tbody = document.querySelector('#ordersTable tbody');
                if (tbody) {
                    observer.observe(tbody, {childList: true, subtree: true});
                }
            }
        } else {
            console.warn('未能找到当日委托相关的DOM元素');
        }


        // 主线个股（人选）- 批量删除
        document.getElementById('batchDeleteTopStocksManualButton').addEventListener('click', batchDeleteTopStocksManual);


        // 为动态生成的 删除按钮 绑定事件
        document.addEventListener('click', function (e) {
            // 当日委托列表：撤单（单个）
            if (e.target.classList.contains('cancel-order-button')) {
                const date = e.target.getAttribute('data-date'); // 委托日期
                const wtbh = e.target.getAttribute('data-wtbh'); // 委托编号
                cancelOrder(date, wtbh, e.target);
            }

            // 主线个股（人选）：删除（单个）
            if (e.target.classList.contains('btn-stockManual-delete-row')) {
                const stockCode = e.target.getAttribute('data-stockcode'); // 个股代码
                deleteTopStockManual(stockCode, e.target);
            }
        });


        // ----------------------------- 页面加载时 加载初始数据

        // 查询持仓
        loadPositions();
        // 查询配置
        loadCfgAccount();
    });


    // window.addEventListener('load', loadPositions);


</script>
</body>
</html>