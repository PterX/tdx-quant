<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的持仓</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 添加全局配置文件 -->
    <script src="../js/config.js"></script>
    <style>
        .sort-icon {
            margin-left: 4px;
            font-size: 12px;
        }

        .margin-buy-button, .buy-button, .sell-button {
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            text-decoration: none; /* Remove underline from links */
            display: inline-block; /* Make links behave like buttons */
            margin: 0 2px; /* Add some space between buttons */
        }

        .margin-buy-button {
            background-color: #ed6a6a; /* Red for Margin Buy */
        }

        .buy-button {
            background-color: #c68989; /* Brownish for Buy */
        }

        .sell-button {
            background-color: #73b5ea; /* Blue for Sell */
        }

        /* Style for the "Select All" checkbox */
        #selectAllCheckbox {
            transform: scale(0.8); /* Make it slightly smaller if needed */
            margin-right: 5px;
        }

        /* Style for individual stock checkboxes */
        .sell-checkbox {
            transform: scale(0.8); /* Make it slightly smaller */
            margin: 0 auto; /* Center it in the cell */
            display: block; /* Ensure it behaves like a block element for centering */
        }

        /* Style for the Sell All button */
        #sellAllButton {
            margin-left: 10px; /* Add some space */
        }

        /* Style for the input for sell percentage */
        #sellPercentageInput {
            width: 80px; /* Adjust width as needed */
            display: inline-block;
            margin-left: 5px;
            margin-right: 5px;
            padding: 2px 5px; /* Adjust padding */
            font-size: 14px; /* Match button font size */
        }

        /* Style for the label */
        #sellPercentageLabel {
            display: inline-block;
            margin-left: 10px; /* Space from the button */
            vertical-align: middle; /* Align vertically with button */
        }

        /* Style for the percentage symbol */
        #percentageSymbol {
            margin-left: 2px; /* Space after the input */
        }

        /* --- 样式调整：缩小表格字体 --- */
        #positionTable, #ordersTable {
            font-size: 13px;
        }

        #positionTable th,
        #positionTable td,
        #ordersTable th,
        #ordersTable td {
            padding: 4px 6px;
            vertical-align: middle;
            text-align: center;
        }

        /* Adjust text alignment for specific columns in Position Table */
        #positionTable th:nth-child(1), /* 序号 */
        #positionTable td:nth-child(1),
        #positionTable th:nth-child(16), /* 操作 */
        #positionTable td:nth-child(16),
        #positionTable th:nth-child(17), /* 新增的勾选列 */
        #positionTable td:nth-child(17) {
            text-align: center; /* Keep center alignment for序号, 操作, and Checkbox */
        }

        #positionTable th:nth-child(2), /* 证券代码 */
        #positionTable td:nth-child(2),
        #positionTable th:nth-child(3), /* 证券名称 */
        #positionTable td:nth-child(3) {
            text-align: left; /* Align left for Code and Name */
        }

        /* Align numbers to the right for better readability in Position Table */
        #positionTable th:nth-child(n+4):nth-child(-n+15):not(:nth-child(4)), /* 除了市场列，其他数字列 */
        #positionTable td:nth-child(n+4):nth-child(-n+15):not(:nth-child(4)) {
            text-align: right;
        }

        /* Adjust text alignment for specific columns in Orders Table */
        #ordersTable th:nth-child(3), /* 证券代码 */
        #ordersTable td:nth-child(3),
        #ordersTable th:nth-child(4), /* 证券名称 */
        #ordersTable td:nth-child(4) {
            text-align: left; /* Align left for Code and Name */
        }

        /* Align numbers to the right for better readability in Orders Table */
        #ordersTable th:nth-child(n+6):nth-child(-n+11), /* 数量, 价格, 金额列 */
        #ordersTable td:nth-child(n+6):nth-child(-n+11) {
            text-align: right;
        }

        /* --- 当日委托新增样式 --- */
        /* Style for Cancel button */
        .cancel-order-button {
            color: white;
            background-color: #6c757d; /* Bootstrap secondary color */
            border: none;
            padding: 3px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .cancel-order-button:hover {
            background-color: #5a6268;
        }

        .cancel-order-button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        /* Style for wtzt status */
        .order-status-已撤 {
            color: gray;
            font-style: italic;
        }

        .order-status-废单 {
            color: red;
            font-weight: bold;
        }

        .order-status-已成 {
            color: green;
        }

        .order-status-部成 {
            color: orange; /* Or blue, depending on preference */
        }

        /* Add styles for other statuses if needed */


    </style>
</head>
<body>
<div class="container mt-4">

    <h2>我的持仓</h2>

    <!-- 资金持仓表单 (保持不动) -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center" onclick="toggleCollapse()">
            <span>资金持仓</span>
            <span class="collapse-btn" onclick="toggleCollapse()">展开/折叠</span>
        </div>
        <div class="card-body collapse-content" id="collapseContent">
            <form>
                <div class="row">
                    <div class="col-md-4">
                        <label for="totalAsset" class="form-label">总资产</label>
                        <input type="text" class="form-control" id="totalAsset" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="totalMktVal" class="form-label">总市值</label>
                        <input type="text" class="form-control" id="totalMktVal" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="accessMoney" class="form-label">可取资金</label>
                        <input type="text" class="form-control" id="accessMoney" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="profit" class="form-label">持仓盈亏</label>
                        <input type="text" class="form-control" id="profit" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="curProfit" class="form-label">当日盈亏</label>
                        <input type="text" class="form-control" id="curProfit" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="posRatio" class="form-label">总仓位</label>
                        <input type="text" class="form-control" id="posRatio" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="netAsset" class="form-label">净资产</label>
                        <input type="text" class="form-control" id="netAsset" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="totalLiability" class="form-label">总负债</label>
                        <input type="text" class="form-control" id="totalLiability" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="marginAvl" class="form-label">可用保证金（可融）</label>
                        <input type="text" class="form-control" id="marginAvl" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="marginRates" class="form-label">维持担保比例</label>
                        <input type="text" class="form-control" id="marginRates" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="ftotaldebts" class="form-label">融资负债</label>
                        <input type="text" class="form-control" id="ftotaldebts" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="avalmoney" class="form-label">可用资金（担）</label>
                        <input type="text" class="form-control" id="avalmoney" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="realrate" class="form-label">实时担保比例</label>
                        <input type="text" class="form-control" id="realrate" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="dtotaldebts" class="form-label">融券负债</label>
                        <input type="text" class="form-control" id="dtotaldebts" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="acreditavl" class="form-label">剩余额度</label>
                        <input type="text" class="form-control" id="acreditavl" readonly>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="holdingStockCount" class="form-label">持仓个股</label>
                        <input type="text" class="form-control" id="holdingStockCount" readonly>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 查询按钮 & 一键卖出 -->
    <div class="d-flex align-items-center mb-3">
        <button id="queryButton" class="btn btn-primary">查询</button>
        <button id="sellAllButton" class="btn btn-danger ms-3">一键等比卖出</button>
        <label for="sellPercentageInput" id="sellPercentageLabel">比例:</label>
        <input type="number" id="sellPercentageInput" class="form-control form-control-sm" value="100" min="0" max="100"
               step="0.1">
        <span id="percentageSymbol">%</span>
    </div>

    <!-- Add Tabs Navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions"
                    type="button" role="tab" aria-controls="positions" aria-selected="true">我的持仓
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button"
                    role="tab" aria-controls="orders" aria-selected="false">当日委托
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="myTabContent">
        <!-- My Positions Tab Content -->
        <div class="tab-pane fade show active" id="positions" role="tabpanel" aria-labelledby="positions-tab">
            <!-- 持仓详情 -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>持仓详情</span>
                    <!-- Select All Checkbox in Header -->
                    <div>
                        <input type="checkbox" id="selectAllCheckbox">
                        <label for="selectAllCheckbox" class="mb-0">全选</label> <!-- mb-0 removes default margin -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="positionTable">
                            <thead>
                            <tr>
                                <th>勾选</th> <!-- New Checkbox Column Header -->
                                <th>序号</th>
                                <th onclick="sortTable('stkcode')">证券代码<span class="sort-icon"
                                                                                 id="sortStkcode"></span></th>
                                <th onclick="sortTable('stkname')">证券名称<span class="sort-icon"
                                                                                 id="sortStkname"></span></th>
                                <th onclick="sortTable('market')">市场<span class="sort-icon" id="sortMarket"></span>
                                </th>
                                <th onclick="sortTable('costprice')">成本价<span class="sort-icon"
                                                                                 id="sortCostprice"></span>
                                </th>
                                <th onclick="sortTable('lastprice')">最新价<span class="sort-icon"
                                                                                 id="sortLastprice"></span>
                                </th>
                                <th onclick="sortTable('mktval')">市值<span class="sort-icon" id="sortMktval"></span>
                                </th>
                                <th onclick="sortTable('profit')">持仓盈亏<span class="sort-icon"
                                                                                id="sortProfit"></span></th>
                                <th onclick="sortTable('profitratio')">持仓盈亏比例<span class="sort-icon"
                                                                                         id="sortProfitratio"></span>
                                </th>
                                <th onclick="sortTable('curprofit')">当日盈亏<span class="sort-icon"
                                                                                   id="sortCurprofit"></span>
                                </th>
                                <th onclick="sortTable('curProfitratio')">当日盈亏比例<span class="sort-icon"
                                                                                            id="sortCurProfitratio"></span>
                                </th>
                                <th onclick="sortTable('posratio')">仓位占比<span class="sort-icon"
                                                                                  id="sortPosratio"></span>
                                </th>
                                <th onclick="sortTable('stkbal')">持仓数量<span class="sort-icon"
                                                                                id="sortStkbal"></span></th>
                                <th onclick="sortTable('stkavl')">可用数量<span class="sort-icon"
                                                                                id="sortStkavl"></span></th>
                                <th onclick="sortTable('industry')">行业<span class="sort-icon"
                                                                              id="sortIndustry"></span></th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- 动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 当日委托 Tab Content -->
        <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>当日委托列表</span>
                    <div class="d-flex align-items-center flex-wrap" id="orders-filter-controls">

                        <!-- 筛选条件 -->
                        <div class="d-flex align-items-center me-3">
                            <label for="filterStatus">委托状态:</label>
                            <select id="filterStatus" class="form-select form-select-sm" style="width:auto">
                                <option value="">全部</option>
                                <option value="未报">未报</option>
                                <option value="已报">已报</option>
                                <option value="已撤">已撤</option>
                                <option value="部成">部成</option>
                                <option value="已成">已成</option>
                                <option value="废单">废单</option>
                            </select>
                        </div>

                        <div class="d-flex align-items-center me-3">
                            <label for="filterDirection">委托方向:</label>
                            <select id="filterDirection" class="form-select form-select-sm" style="width:auto">
                                <option value="">全部</option>
                                <option value="证券买入">证券买入</option>
                                <option value="证券卖出">证券卖出</option>
                            </select>
                        </div>

                        <button id="refreshOrdersButton" class="btn btn-success btn-sm">刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" id="ordersTable">
                            <thead>
                            <tr>
                                <th onclick="sortOrdersTable('wtrq')">委托日期<span class="sort-icon"
                                                                                    id="sortWtrq"></span></th>
                                <th onclick="sortOrdersTable('wtsj')">委托时间<span class="sort-icon"
                                                                                    id="sortwtsj"></span></th>
                                <th onclick="sortOrdersTable('zqdm')">证券代码<span class="sort-icon"
                                                                                    id="sortZqdm"></span></th>
                                <th onclick="sortOrdersTable('zqmc')">证券名称<span class="sort-icon"
                                                                                    id="sortZqmc"></span></th>
                                <th onclick="sortOrdersTable('mmsm')">委托方向<span class="sort-icon"
                                                                                    id="sortMmsm"></span></th>
                                <th onclick="sortOrdersTable('wtzt')">委托状态<span class="sort-icon"
                                                                                    id="sortWtzt"></span></th>
                                <th onclick="sortOrdersTable('wtjg')">委托价格<span class="sort-icon"
                                                                                    id="sortWtjg"></span></th>
                                <th onclick="sortOrdersTable('wtsl')">委托数量<span class="sort-icon"
                                                                                    id="sortWtsl"></span></th>
                                <th onclick="sortOrdersTable('wtje')">委托金额<span class="sort-icon"
                                                                                    id="sortWtje"></span></th>
                                <th onclick="sortOrdersTable('cjjg')">成交价格<span class="sort-icon"
                                                                                    id="sortCjjg"></span></th>
                                <th onclick="sortOrdersTable('cjsl')">成交数量<span class="sort-icon"
                                                                                    id="sortCjsl"></span></th>
                                <th onclick="sortOrdersTable('cjje')">成交金额<span class="sort-icon"
                                                                                    id="sortCjje"></span></th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="ordersTableMessage" class="text-center text-muted mt-3">暂无委托记录</div>
                    <!-- Message placeholder -->
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 存储排序状态 (持仓)
    let sortState = {column: 'mktval', order: 'desc'};
    let positionsData = [];

    // 存储排序状态 (委托)
    let ordersSortState = {column: null, order: 'asc'};
    let ordersData = [];

    // --- 通用函数 ---
    function market2Xueqiu(market) {
        return market === "SA" ? "SZ" : market === "HA" ? "SH" : "BJ";
    }

    // --- 原有持仓功能 ---
    // 更新排序图标函数 (持仓)
    function updateSortIcon() {
        const iconIdPrefix = `sort${sortState.column.charAt(0).toUpperCase() + sortState.column.slice(1)}`;
        const iconElement = document.getElementById(iconIdPrefix);

        if (iconElement) {
            iconElement.textContent = sortState.order === 'asc' ? '↑' : '↓';
        }

        // 清除其他列的排序图标
        const allIcons = document.querySelectorAll('#positionTable th span.sort-icon');
        allIcons.forEach(icon => {
            if (icon !== iconElement) {
                icon.textContent = '';
            }
        });
    }

    // 初始化排序图标函数 (持仓)
    function initializeSortIcons() {
        if (sortState.column) {
            updateSortIcon();
        }
    }

    // 展开/折叠详细信息
    function toggleCollapse() {
        const content = document.getElementById('collapseContent');
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    }

    // 排序函数：仅触发排序 (持仓)
    function sortTable(column) {
        if (sortState.column === column) {
            sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.order = 'desc';
            sortState.column = column;
        }
        updateSortIcon();
        showPositionRecords(positionsData);
    }

    // 显示持仓记录
    function showPositionRecords(positions) {
        const tbody = document.querySelector('#positionTable tbody');
        if (!tbody) {
            console.error('未找到 #positionTable tbody');
            return;
        }

        tbody.innerHTML = '';
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="17">暂无持仓记录</td></tr>';
            return;
        }

        const holdingStockCount = positions.length;
        document.getElementById('holdingStockCount').value = holdingStockCount.toLocaleString('en-US');

        let sortedPositions = [...positions];
        if (sortState.column) {
            sortedPositions = sortedPositions.sort((a, b) => {
                const valA = a[sortState.column] ?? 0;
                const valB = b[sortState.column] ?? 0;

                if (!isNaN(valA) && !isNaN(valB)) {
                    return sortState.order === 'asc' ? valA - valB : valB - valA;
                }

                if (typeof valA === 'string' && typeof valB === 'string') {
                    return sortState.order === 'asc'
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }

                return 0;
            });
        }

        sortedPositions.forEach((item, index) => {
            const marketPrefix = market2Xueqiu(item.market);
            const stockLink = `https://xueqiu.com/S/${marketPrefix}${item.stkcode}`;
            const tr = document.createElement('tr');
            tr.setAttribute('data-stkcode', item.stkcode);

            tr.innerHTML = `
              <td><input type="checkbox" class="sell-checkbox"></td>
              <td>${index + 1}</td>
              <td><a href="${stockLink}" target="_blank">${item.stkcode}</a></td>
              <td>${item.stkname}</td>
              <td>${item.market}</td>
              <td>${Number(item.costprice).toFixed(3).replace(/\.?0+$/, '')}</td>
              <td>${Number(item.lastprice).toFixed(3).replace(/\.?0+$/, '')}</td>
              <td>${item.mktval.toFixed(2)}</td>
              <td style="color: ${item.profit > 0 ? 'red' : item.profit < 0 ? 'teal' : 'black'}">${item.profit.toFixed(2)}</td>
              <td style="color: ${item.profitratio > 0 ? 'red' : item.profitratio < 0 ? 'teal' : 'black'}">${(item.profitratio * 100).toFixed(2)}%</td>
              <td style="color: ${item.curprofit > 0 ? 'red' : item.curprofit < 0 ? 'teal' : 'black'}">${item.curprofit?.toFixed(2) ?? '-'}</td>
              <td style="color: ${item.curProfitratio > 0 ? 'red' : item.curProfitratio < 0 ? 'teal' : 'black'}">${item.curProfitratio == null ? '-' : (item.curProfitratio * 100).toFixed(2) + '%'}</td>
              <td>${(item.posratio * 100).toFixed(2)}%</td>
              <td>${item.stkbal}</td>
              <td>${item.stkavl}</td>
              <td>
                ${(() => {
                const hyBlock = item.blockInfoDTO?.hyBlockDTOList || [];
                const normalIndustry = hyBlock.find(b => b.blockType === 2);
                const researchIndustry = hyBlock.find(b => b.blockType === 12);
                const normalName = normalIndustry ? normalIndustry.blockNamePath.split('-')[1] : '';
                const researchName = researchIndustry ? researchIndustry.blockNamePath.split('-')[0] : '';
                const industryStr = [normalName, researchName].filter(Boolean).join(' / ');
                item.industry = industryStr;
                return industryStr;
            })()}
              </td>
              <td>
                <a class="margin-buy-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/MarginBuy?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >融</a>
                <a class="buy-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/Buy?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >担</a>
                <a class="sell-button" target="_blank"
                  href="https://jywg.18.cn/MarginTrade/Sale?code=${item.stkcode}&name=${encodeURIComponent(item.stkname)}&zqlx=${item.stktype_ex}&mt=${item.market === 'HA' ? 1 : item.market === 'SA' ? 2 : 'B'}&market=${item.market}"
                >卖</a>
              </td>
            `;
            tbody.appendChild(tr);
        });

        attachCheckboxListeners();
    }

    // Function to attach event listeners for checkboxes
    function attachCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.sell-checkbox');
        checkboxes.forEach(checkbox => {
            // Optional: Add individual change listener if needed for other features
        });

        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.removeEventListener('change', handleSelectAllChange);
            selectAllCheckbox.addEventListener('change', handleSelectAllChange);
        }
    }

    // Handle "Select All" checkbox change
    function handleSelectAllChange() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.sell-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

    // --- 新增：一键卖出功能 ---
    function handleSellAll() {
        const selectedCheckboxes = document.querySelectorAll('.sell-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一只股票进行卖出。');
            return;
        }

        const sellStockCodes = [];
        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                const stkcode = row.getAttribute('data-stkcode');
                if (stkcode) {
                    sellStockCodes.push(stkcode);
                }
            }
        });

        if (sellStockCodes.length === 0) {
            alert('未能获取到选中股票的代码，请重试。');
            return;
        }

        const sellPctInput = document.getElementById('sellPercentageInput');
        let sellPct = parseFloat(sellPctInput.value);

        if (isNaN(sellPct) || sellPct < 0 || sellPct > 100) {
            alert('请输入有效的卖出比例 (0-100%)。');
            sellPctInput.focus();
            return;
        }

        const confirmMsg = `您确定要按 ${sellPct}% 的比例卖出以下 ${sellStockCodes.length} 只股票吗？\n${sellStockCodes.join(', ')}`;
        if (!confirm(confirmMsg)) {
            return;
        }

        const sellStockCodeList = sellStockCodes.join(',');

        const originalBtnText = document.getElementById('sellAllButton').textContent;
        document.getElementById('sellAllButton').textContent = '处理中...';
        document.getElementById('sellAllButton').disabled = true;

        ApiUtils.fetch(`/api/trade/quickOption/sellPosition?sellStockCodeList=${encodeURIComponent(sellStockCodeList)}&sellPct=${sellPct}`, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.msg || `HTTP error! status: ${response.status}`);
                    }).catch(e => {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success === true) {
                    alert(`一键卖出操作成功！`);
                    queryPositions();
                } else {
                    const errorMsg = data.msg || '操作失败，未知错误。';
                    alert(`一键卖出失败: ${errorMsg}`);
                    console.error('Sell API Error:', data);
                }
            })
            .catch(error => {
                console.error('一键卖出请求失败:', error);
                alert(`一键卖出请求失败: ${error.message || error}`);
            })
            .finally(() => {
                document.getElementById('sellAllButton').textContent = originalBtnText;
                document.getElementById('sellAllButton').disabled = false;
            });
    }

    document.getElementById('sellAllButton').addEventListener('click', handleSellAll);

    // 查询持仓数据
    function queryPositions() {
        ApiUtils.fetch('/api/trade/queryCreditNewPosV2')
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('加载失败: ' + data.msg);
                    return;
                }

                const responseData = data.data;
                positionsData = responseData.stocks;

                const setColor = (elementId, value) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.value = value.toLocaleString('en-US', {minimumFractionDigits: 2});
                        el.style.color = value > 0 ? 'red' : value < 0 ? 'teal' : 'black';
                    }
                };

                const setColor_rz = (elementId, value) => {
                    const el2 = document.getElementById(elementId);
                    if (el2) {
                        el2.value = value.toLocaleString('en-US', {minimumFractionDigits: 2});
                        el2.style.color = 'teal';
                    }
                };

                const totalAssetEl = document.getElementById('totalAsset');
                if (totalAssetEl) totalAssetEl.value = responseData.totalasset.toLocaleString('en-US', {minimumFractionDigits: 2});

                const totalMktValEl = document.getElementById('totalMktVal');
                if (totalMktValEl) totalMktValEl.value = responseData.totalmkval.toLocaleString('en-US', {minimumFractionDigits: 2});

                const accessMoneyEl = document.getElementById('accessMoney');
                if (accessMoneyEl) accessMoneyEl.value = responseData.accessmoney.toLocaleString('en-US', {minimumFractionDigits: 2});

                setColor('profit', responseData.profit);
                setColor('curProfit', responseData.curprofit ?? 0);

                const posRatioEl = document.getElementById('posRatio');
                if (posRatioEl) posRatioEl.value = `${(responseData.posratio * 100).toFixed(2)}%`;

                const netAssetEl = document.getElementById('netAsset');
                if (netAssetEl) netAssetEl.value = responseData.netasset.toLocaleString('en-US', {minimumFractionDigits: 2});

                setColor_rz('totalLiability', responseData.totalliability);
                setColor_rz('marginAvl', responseData.marginavl);

                const marginRatesEl = document.getElementById('marginRates');
                if (marginRatesEl) marginRatesEl.value = `${(responseData.marginrates * 100).toFixed(2)}%`;

                setColor_rz('ftotaldebts', responseData.ftotaldebts);
                setColor('avalmoney', responseData.avalmoney);

                const realrateEl = document.getElementById('realrate');
                if (realrateEl) realrateEl.value = `${(responseData.realrate * 100).toFixed(2)}%`;

                const dtotaldebtsEl = document.getElementById('dtotaldebts');
                if (dtotaldebtsEl) dtotaldebtsEl.value = responseData.dtotaldebts.toLocaleString('en-US', {minimumFractionDigits: 2});

                const acreditavlEl = document.getElementById('acreditavl');
                if (acreditavlEl) acreditavlEl.value = responseData.acreditavl.toLocaleString('en-US', {minimumFractionDigits: 2});

                const holdingStockCountEl = document.getElementById('holdingStockCount');
                if (holdingStockCountEl) holdingStockCountEl.value = (positionsData ? positionsData.length : 0).toLocaleString('en-US');

                showPositionRecords(positionsData);
                initializeSortIcons();
            })
            .catch(error => {
                console.error('接口请求失败:', error);
                alert('加载数据失败，请检查网络或接口是否正常: ' + error.message);
            });
    }

    document.getElementById('queryButton').addEventListener('click', queryPositions);
    window.addEventListener('load', queryPositions);


    // --- 新增：当日委托功能 ---

    // Function to update sort icons for orders table
    function updateOrdersSortIcon() {
        const iconIdPrefix = `sort${ordersSortState.column ? ordersSortState.column.charAt(0).toUpperCase() + ordersSortState.column.slice(1) : ''}`;
        const iconElement = document.getElementById(iconIdPrefix);

        const allIcons = document.querySelectorAll('#ordersTable th span.sort-icon');
        allIcons.forEach(icon => {
            icon.textContent = '';
        });

        if (iconElement && ordersSortState.column) {
            iconElement.textContent = ordersSortState.order === 'asc' ? '↑' : '↓';
        }
    }

    // Sorting function for orders table (only triggers sort)
    function sortOrdersTable(column) {
        if (ordersSortState.column === column) {
            ordersSortState.order = ordersSortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            ordersSortState.order = 'asc';
            ordersSortState.column = column;
        }
        updateOrdersSortIcon();
        displayOrders(ordersData);
    }

    // Function to display orders in the table
    function displayOrders(orders) {
        const tbody = document.querySelector('#ordersTable tbody');
        const messageDiv = document.getElementById('ordersTableMessage');
        if (!tbody || !messageDiv) {
            console.error('未找到 #ordersTable tbody 或 #ordersTableMessage');
            return;
        }

        const statusFilter = document.getElementById('filterStatus').value;
        const directionFilter = document.getElementById('filterDirection').value;

        let filteredOrders = orders;
        if (statusFilter) {
            filteredOrders = filteredOrders.filter(order => order.wtzt === statusFilter);
        }
        if (directionFilter) {
            filteredOrders = filteredOrders.filter(order => order.mmsm === directionFilter);
        }

        let sortedOrders = [...filteredOrders];
        if (ordersSortState.column) {
            sortedOrders.sort((a, b) => {
                let valA = a[ordersSortState.column];
                let valB = b[ordersSortState.column];

                if (valA == null) valA = '';
                if (valB == null) valB = '';

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return ordersSortState.order === 'asc' ? numA - numB : numB - numA;
                }

                const comparison = String(valA).localeCompare(String(valB));
                return ordersSortState.order === 'asc' ? comparison : -comparison;
            });
        }

        tbody.innerHTML = '';

        if (sortedOrders.length === 0) {
            messageDiv.style.display = 'block';
            messageDiv.textContent = '暂无匹配的委托记录';
        } else {
            messageDiv.style.display = 'none';

            sortedOrders.forEach((order, index) => {
                const marketPrefix = market2Xueqiu(order.market);
                const stockLink = `https://xueqiu.com/S/${marketPrefix}${order.zqdm}`;

                const tr = document.createElement('tr');

                let formattedTime = order.wtsj;
                if (order.wtsj && order.wtsj.length === 6) {
                    formattedTime = `${order.wtsj.substring(0, 2)}:${order.wtsj.substring(2, 4)}:${order.wtsj.substring(4, 6)}`;
                }

                tr.innerHTML = `
                    <td>${order.wtrq}</td>
                    <td>${formattedTime}</td>
                    <td><a href="${stockLink}" target="_blank">${order.zqdm}</a></td>
                    <td>${order.zqmc}</td>
                    <td>${order.mmsm}</td>
                    <td class="order-status-${order.wtzt}">${order.wtzt}</td>
                    <td>${Number(order.wtjg).toFixed(3)}</td>
                    <td>${order.wtsl}</td>
                    <td>${Number(order.wtje).toFixed(3)}</td>
                    <td>${Number(order.cjjg).toFixed(3)}</td>
                    <td>${order.cjsl}</td>
                    <td>${Number(order.cjje).toFixed(2)}</td>
                    <td>
                        ${(order.wtzt === '已报' || order.wtzt === '部成') ?
                    `<button class="cancel-order-button" data-wtbh="${order.Wtbh}" data-market="${order.Market}">撤单</button>` :
                    '-'
                }
                    </td>
                 `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.cancel-order-button').forEach(button => {
                button.addEventListener('click', function () {
                    const wtbh = this.getAttribute('data-wtbh');
                    const market = this.getAttribute('data-market');
                    cancelOrder(wtbh, market, this);
                });
            });
        }
    }

    // Function to fetch and load orders
    function loadOrders() {
        const refreshBtn = document.getElementById('refreshOrdersButton');
        const originalText = refreshBtn.textContent;
        refreshBtn.textContent = '加载中...';
        refreshBtn.disabled = true;

        ApiUtils.fetch('/api/trade/getOrdersData')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.msg || '获取委托数据失败');
                }
                ordersData = data.data || [];
                displayOrders(ordersData);
                updateOrdersSortIcon();
            })
            .catch(error => {
                console.error('获取当日委托失败:', error);
                const tbody = document.querySelector('#ordersTable tbody');
                const messageDiv = document.getElementById('ordersTableMessage');
                if (tbody && messageDiv) {
                    tbody.innerHTML = '';
                    messageDiv.style.display = 'block';
                    messageDiv.textContent = `加载失败: ${error.message}`;
                }
            })
            .finally(() => {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            });
    }

    // Function to cancel an order (Placeholder - needs backend implementation)
    function cancelOrder(wtbh, market, buttonElement) {
        if (!confirm(`确定要撤销委托编号 ${wtbh} 吗？`)) {
            return;
        }

        const originalText = buttonElement.textContent;
        buttonElement.textContent = '撤销中...';
        buttonElement.disabled = true;

        // Prepare parameters for cancellation API
        // Adjust endpoint and parameters based on your actual backend API
        const cancelParams = new URLSearchParams({wtbh: wtbh, market: market});

        ApiUtils.fetch(`/api/trade/cancelOrder?${cancelParams.toString()}`, {
            method: 'POST', // Or GET, check your backend
        })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(errData => {
                        throw new Error(errData.msg || `撤销失败 HTTP ${res.status}`);
                    }).catch(() => {
                        throw new Error(`撤销失败 HTTP ${res.status}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    alert(`委托 ${wtbh} 撤销成功！`);
                    loadOrders(); // Reload orders
                } else {
                    throw new Error(data.msg || '撤销操作未成功');
                }
            })
            .catch(error => {
                console.error('撤销委托失败:', error);
                alert(`撤销委托 ${wtbh} 失败: ${error.message}`);
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            });
    }

    // Attach event listeners for filters and refresh
    document.addEventListener('DOMContentLoaded', function () {
        const ordersTab = document.getElementById('orders-tab');
        const filterStatus = document.getElementById('filterStatus');
        const filterDirection = document.getElementById('filterDirection');
        const refreshOrdersButton = document.getElementById('refreshOrdersButton');

        if (ordersTab && filterStatus && filterDirection && refreshOrdersButton) {
            let hasLoadedOrders = false;
            ordersTab.addEventListener('shown.bs.tab', function (event) {
                if (!hasLoadedOrders) {
                    loadOrders();
                    hasLoadedOrders = true;
                }
            });

            refreshOrdersButton.addEventListener('click', loadOrders);
            filterStatus.addEventListener('change', () => displayOrders(ordersData));
            filterDirection.addEventListener('change', () => displayOrders(ordersData));
        } else {
            console.warn('未能找到当日委托相关的DOM元素');
        }
    });

    // --- 结束：当日委托功能 ---
</script>
</body>
</html>